"use strict";(self.webpackChunktechlife=self.webpackChunktechlife||[]).push([[654],{654:(e,t,s)=>{s.r(t),s.d(t,{default:()=>$});var r=s(5043),a=s(3721),n=s(6213);let l=!1,i=[];const o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i.forEach(s=>{e?s.reject(e):s.resolve(t)}),i=[]},c=e=>{const t=n.A.create({baseURL:e});return t.interceptors.request.use(e=>{const t=localStorage.getItem("accessToken");return t&&(e.headers.Authorization=`Bearer ${t}`),console.log("Request Headers (from Interceptor):",e.headers),e},e=>Promise.reject(e)),t.interceptors.response.use(e=>e,async s=>{var r;const a=s.config;if(401===(null===(r=s.response)||void 0===r?void 0:r.status)&&!a._retry){if(l)return new Promise((e,t)=>{i.push({resolve:e,reject:t})}).then(e=>(a.headers.Authorization=`Bearer ${e}`,t(a))).catch(e=>Promise.reject(e));a._retry=!0,l=!0;const s=localStorage.getItem("accessToken");console.log(`\ud83d\udd34 Token expired for ${e}. Old Token:`,s);try{const t=await n.A.post("http://hrms.anasolconsultancyservices.com/api/auth/refresh-token",{},{withCredentials:!0}),{accessToken:s}=t.data;localStorage.setItem("accessToken",s),console.log(`\ud83d\udfe2 New Token for ${e}:`,s),a.data instanceof FormData&&(a.data=function(e){const t=new FormData;for(let[s,r]of e.entries())t.append(s,r);return t}(a.data)),o(null,s);const r=c(e);return a.headers.Authorization=`Bearer ${s}`,r(a)}catch(d){return console.error("Refresh token failed. Logging out.",d),localStorage.clear(),window.location.href="/login",o(d),Promise.reject(d)}finally{l=!1}}return Promise.reject(s)}),t};window.addEventListener("storage",e=>{"accessToken"===e.key&&console.log("\ud83d\udd04 Token updated in another tab:",e.newValue)});const d=c("http://hrms.anasolconsultancyservices.com/api"),u=async function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:15;try{const a=await d.get(`/chat/${e}/${t}?page=${s}&size=${r}`);return console.log(`Response for messages page ${s}:`,a),a.data}catch(a){return console.error(`Failed to fetch messages for chat ${t}:`,a),[]}};var m=s(2397);const g=(e,t)=>{if(!e.lastMessage||"Chat cleared"===e.lastMessage)return"";const s=e.lastMessage,r=e.lastMessageSenderId===t?"You: ":"";if(e.lastMessageType)switch(e.lastMessageType.toUpperCase()){case"IMAGE":return r+"\ud83d\udcf7 Image";case"AUDIO":return r+"\ud83c\udfa4 Voice Message";case"FILE":return r+`\ud83d\udcce ${s}`;case"DELETED":return"This message was deleted"}return s.match(/\.(jpeg|jpg|gif|png|webp)$/i)?r+"\ud83d\udcf7 Image":s.match(/\.(mp3|wav|ogg|m4a|webm)$/i)?r+"\ud83c\udfa4 Voice Message":s.match(/\.(pdf|doc|docx|ppt|pptx|xls|xlsx|zip|rar)$/i)?r+`\ud83d\udcce ${s}`:r+s},h=e=>{let t;try{if(e.timestamp){const s=String(e.timestamp);t=new Date(s.endsWith("Z")?s:s+"Z").toISOString()}else t=e.date&&e.time?new Date(`${e.date} ${e.time} UTC`).toISOString():(new Date).toISOString()}catch(l){t=(new Date).toISOString()}let s="text",r=e.fileUrl||null;e.fileName?s=e.fileType?e.fileType.startsWith("image/")?"image":e.fileType.startsWith("audio/")?"audio":e.fileType.startsWith("video/")?"video":"file":e.fileName.match(/\.(jpeg|jpg|gif|png|webp)$/i)?"image":e.fileName.match(/\.(mp3|wav|ogg|m4a)$/i)?"audio":e.fileName.match(/\.(mp4|webm|mov)$/i)?"video":"file":e.kind&&"text"!==e.kind&&(s=e.kind.toLowerCase());const a=e.id||e.messageId;if(!r&&["image","video","audio","file"].includes(s)&&a){r=`${m.Pt.defaults.baseURL}/chat/file/${a}`}e.isDeleted&&(s="deleted");const n=e.id||e.messageId;return{id:n,messageId:n,content:e.content,sender:e.sender,timestamp:t,status:!0===e.seen||"true"===String(e.isSeen)?"seen":"sent",type:s,isEdited:e.isEdited||!1,isPinned:e.pinned||!1,fileName:e.fileName||null,fileUrl:r,fileSize:e.fileSize||null,duration:e.duration||0,clientId:e.clientId||null,isForwarded:e.forwarded||!1,forwardedFrom:e.forwardedFrom||null,isReply:!!e.replyTo,replyTo:e.replyTo?{sender:e.replyTo.senderId,content:e.replyTo.content,originalMessageId:e.replyTo.originalMessageId,type:e.replyTo.type}:null}};var p=s(1266),f=s(184),x=s(1462),y=s(4258),v=s(579);const b=e=>{if(!e||0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]},j=e=>{var t;let{fileName:s,className:r="text-3xl"}=e;const a=null===s||void 0===s||null===(t=s.split(".").pop())||void 0===t?void 0:t.toLowerCase();return["pdf"].includes(a)?(0,v.jsx)(f.kl1,{className:`text-red-500 ${r}`}):["doc","docx"].includes(a)?(0,v.jsx)(f.WLb,{className:`text-blue-700 ${r}`}):["ppt","pptx"].includes(a)?(0,v.jsx)(f.rgF,{className:`text-orange-500 ${r}`}):["xls","xlsx"].includes(a)?(0,v.jsx)(f.Ru,{className:`text-green-600 ${r}`}):["zip","rar","7z"].includes(a)?(0,v.jsx)(f.aw1,{className:`text-yellow-500 ${r}`}):["png","jpg","jpeg","gif","webp"].includes(a)?(0,v.jsx)(f.dkL,{className:`text-purple-500 ${r}`}):["mp3","wav","ogg"].includes(a)?(0,v.jsx)(f.EVA,{className:`text-pink-500 ${r}`}):(0,v.jsx)(f.t69,{className:`text-gray-500 ${r}`})},w=e=>{let{msg:t,isMyMessage:s}=e;const r=`${d.defaults.baseURL}/chat/file/${t.messageId}`,a=(0,v.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg max-w-xs md:max-w-sm "+(s?"bg-blue-600":"bg-gray-200"),children:[(0,v.jsx)("div",{className:"flex-shrink-0 p-2 bg-white/20 rounded-lg",children:(0,v.jsx)(j,{fileName:t.fileName,className:"text-4xl"})}),(0,v.jsxs)("div",{className:"flex-grow overflow-hidden mr-2",children:[(0,v.jsx)("p",{className:"font-semibold truncate "+(s?"text-white":"text-gray-800"),children:t.fileName}),(0,v.jsx)("p",{className:"text-sm "+(s?"text-blue-200":"text-gray-600"),children:b(t.fileSize)})]}),(0,v.jsx)("div",{onClick:e=>{e.preventDefault(),e.stopPropagation(),window.open(r,"_blank")},className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-black/20 hover:bg-black/30 text-white transition-colors cursor-pointer",children:(0,v.jsx)(f.WCW,{size:18})})]});return s?a:(0,v.jsx)("div",{onClick:()=>window.open(r,"_blank"),className:"cursor-pointer",children:a})},N=e=>{let{src:t,fileUrl:s,isSender:a,initialDuration:n=0,fileSize:l=0}=e;const i=(0,r.useRef)(null),[o,c]=(0,r.useState)(!1),[d,u]=(0,r.useState)(0),[m,g]=(0,r.useState)(n),[h,p]=(0,r.useState)(t||null),[x,y]=(0,r.useState)(!1);(0,r.useEffect)(()=>{const e=i.current;if(!e)return;const t=()=>{e.duration!==1/0&&e.duration>0&&g(e.duration)},s=()=>u(e.currentTime),r=()=>c(!1);return e.addEventListener("loadedmetadata",t),e.addEventListener("timeupdate",s),e.addEventListener("ended",r),()=>{e.removeEventListener("loadedmetadata",t),e.removeEventListener("timeupdate",s),e.removeEventListener("ended",r)}},[h]);const j=async()=>{if(!x){y(!0);try{const e=await fetch(s),t=await e.blob(),r=URL.createObjectURL(t);p(r)}catch(e){console.error("Failed to download audio:",e)}finally{y(!1)}}},w=e=>{if(!e||e===1/0)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`},N=m?d/m*100:0;return h?(0,v.jsxs)("div",{className:"flex items-center gap-3 p-2 w-64",children:[(0,v.jsx)("audio",{ref:i,src:h,preload:"metadata"}),(0,v.jsx)("button",{onClick:()=>{i.current&&(o?i.current.pause():i.current.play().catch(e=>console.error("Audio play failed:",e)),c(!o))},className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center "+(a?"bg-white text-blue-600":"bg-gray-400 bg-opacity-30 text-white"),children:o?(0,v.jsx)(f.kwt,{size:16}):(0,v.jsx)(f.gSK,{size:16,className:"ml-1"})}),(0,v.jsxs)("div",{className:"flex-grow flex flex-col justify-center",children:[(0,v.jsx)("div",{className:"w-full h-1.5 bg-black/20 rounded-full cursor-pointer",onClick:e=>{if(!m)return;const t=e.currentTarget.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*m;i.current&&(i.current.currentTime=s)},children:(0,v.jsx)("div",{style:{width:`${N}%`},className:"h-full rounded-full "+(a?"bg-white":"bg-gray-300")})}),(0,v.jsx)("span",{className:"text-xs self-end mt-1 "+(a?"text-blue-200":"text-gray-500"),children:w(m)})]})]}):(0,v.jsxs)("div",{className:"flex items-center gap-3 p-2 w-64",children:[x?(0,v.jsx)("div",{className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-gray-400 bg-opacity-30",children:(0,v.jsx)("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"})}):(0,v.jsx)("button",{onClick:j,className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-gray-400 bg-opacity-30 text-white hover:bg-opacity-40 transition-colors",children:(0,v.jsx)(f.WCW,{size:16})}),(0,v.jsxs)("div",{className:"flex-grow flex flex-col justify-center",children:[(0,v.jsx)("p",{className:"text-sm text-gray-700",children:"Voice Message"}),(0,v.jsxs)("div",{className:"flex justify-between items-center mt-1",children:[(0,v.jsx)("span",{className:"text-xs text-gray-500",children:b(l)}),(0,v.jsx)("span",{className:"text-xs text-gray-500",children:w(m)})]})]})]})},I=()=>(0,v.jsxs)("div",{className:"space-y-4 p-4",children:[(0,v.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,v.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 animate-pulse flex-shrink-0"}),(0,v.jsx)("div",{className:"h-10 rounded-lg bg-gray-200 animate-pulse w-48"})]}),(0,v.jsxs)("div",{className:"flex items-end gap-2 justify-end",children:[(0,v.jsx)("div",{className:"h-12 rounded-lg bg-blue-200 animate-pulse w-32"}),(0,v.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 animate-pulse flex-shrink-0"})]}),(0,v.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,v.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 animate-pulse flex-shrink-0"}),(0,v.jsx)("div",{className:"h-16 rounded-lg bg-gray-200 animate-pulse w-64"})]}),(0,v.jsxs)("div",{className:"flex items-end gap-2 justify-end",children:[(0,v.jsx)("div",{className:"h-10 rounded-lg bg-blue-200 animate-pulse w-40"}),(0,v.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 animate-pulse flex-shrink-0"})]}),(0,v.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,v.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 animate-pulse flex-shrink-0"}),(0,v.jsx)("div",{className:"h-10 rounded-lg bg-gray-200 animate-pulse w-32"})]})]});const S=function(e){let{currentUser:t,chats:s,loadMoreChats:a,hasMore:n,isFetchingMore:l}=e;const[i,o]=(0,r.useState)({groups:[],privateChatsWith:[]}),[c,m]=(0,r.useState)(""),[b,S]=(0,r.useState)(null),[k,C]=(0,r.useState)(""),[$,T]=(0,r.useState)({}),[M,E]=(0,r.useState)(!1),[R,D]=(0,r.useState)(!1),[F,z]=(0,r.useState)(!1),[L,A]=(0,r.useState)(!1),[U,W]=(0,r.useState)(!1),[P,O]=(0,r.useState)({}),[B,V]=(0,r.useState)({visible:!1,x:0,y:0,message:null,index:null}),[q,H]=(0,r.useState)({index:null,originalContent:""}),[Y,_]=(0,r.useState)(null),[Z,G]=(0,r.useState)(null),[J,X]=(0,r.useState)(null),[K,Q]=(0,r.useState)({visible:!1,message:null}),[ee,te]=(0,r.useState)([]),[se,re]=(0,r.useState)(""),[ae,ne]=(0,r.useState)(!1),[le,ie]=(0,r.useState)(!1),[oe,ce]=(0,r.useState)(!1),[de,ue]=(0,r.useState)("Overview"),[me,ge]=(0,r.useState)([]),[he,pe]=(0,r.useState)(!1),[fe,xe]=(0,r.useState)(null),[ye,ve]=(0,r.useState)(!1),[be,je]=(0,r.useState)(!1),[we,Ne]=(0,r.useState)(!1),[Ie,Se]=(0,r.useState)({}),[ke,Ce]=(0,r.useState)({}),[$e,Te]=(0,r.useState)({}),[Me,Ee]=(0,r.useState)(!1),[Re,De]=(0,r.useState)(!1),[Fe,ze]=(0,r.useState)(0),Le=(0,r.useRef)(null),Ae=(0,r.useRef)(null),Ue=(0,r.useRef)(null),We=(0,r.useRef)({}),Pe=(0,r.useRef)(null),Oe=(0,r.useRef)(null),Be=(0,r.useRef)([]),Ve=(0,r.useRef)(null),qe=(0,r.useRef)(null),He=(0,r.useRef)(null),Ye=(0,r.useRef)(null),_e=(0,r.useRef)(null),Ze=(0,r.useRef)(null),Ge=(0,r.useRef)(null),Je=(0,r.useRef)(null),Xe=(0,r.useRef)(null),Ke=(0,r.useRef)(!1),Qe=(0,r.useRef)({}),et=(0,r.useMemo)(()=>{if("undefined"!==typeof window&&window.location.pathname.includes("/with")){return new URLSearchParams(window.location.search).get("id")}return null},[]),tt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth";Ae.current&&Ae.current.scrollTo({top:Ae.current.scrollHeight,behavior:e}),ze(0)};(0,r.useEffect)(()=>{if(s){const e={groups:s.groups.map(e=>e.chatId.toString()===et?{...e,unreadMessageCount:0}:e),privateChatsWith:s.privateChatsWith.map(e=>e.chatId.toString()===et?{...e,unreadMessageCount:0}:e)};o(e),ve(!0)}},[s,et]);const st=(0,r.useCallback)(async(e,s)=>{if(!(s>0&&Me||0===s&&M)){s>0?(Ee(!0),Ke.current=!0):E(!0);try{const r=await u(t.id,e,s,15);if(console.log("%c REFRESH (API) RAW DATA:","color: red; font-weight: bold;",r),0===r.length)return void Te(t=>({...t,[e]:!1}));const a=r.map(h),n=Ae.current,l=n?n.scrollHeight:0,i=n?n.scrollTop:0;T(t=>({...t,[e]:0===s?a:[...a,...t[e]||[]]})),s>0&&requestAnimationFrame(()=>{n&&(n.scrollTop=n.scrollHeight-l+i)}),0===r.length&&Te(t=>({...t,[e]:!1}))}catch(r){console.error(`Failed to load messages for chat ${e}:`,r)}finally{s>0?(Ee(!1),setTimeout(()=>{Ke.current=!1},100)):E(!1)}}},[t.id,Me,M,u]);(0,r.useEffect)(()=>{if(!b)return;const e=b.chatId;Ce(t=>({...t,[e]:0})),Te(t=>({...t,[e]:!0})),T(t=>({...t,[e]:[]})),st(e,0);(async()=>{try{const s=await(async(e,t,s)=>{try{const r=await d.get(`/chat/${e}/pinned?chatType=${t}&userId=${s}`);return console.log("Response:",r),r.data}catch(r){return console.error(`Failed to fetch pinned message for chat ${e}:`,r),null}})(e,b.type,t.id);X(s)}catch(s){console.error("Failed to fetch pinned message:",s),X(null)}})()},[b,t.id]);const rt=(0,r.useCallback)((e,s)=>{o(r=>{const a=r=>{if(r.chatId===e){const a=s&&"deleted"!==s.type&&!s.isDeleted&&s.sender!==t.id&&(null===b||void 0===b?void 0:b.chatId)!==e,n={lastMessage:s?s.fileName||s.content:"",lastMessageType:s?s.type.toUpperCase():null,lastMessageSenderId:s?s.sender:null};return{...r,lastMessage:s?g(n,t.id):"Chat cleared",lastMessageTimestamp:(null===s||void 0===s?void 0:s.timestamp)||new Date(0).toISOString(),unreadMessageCount:(r.unreadMessageCount||0)+(a?1:0)}}return r};return{groups:r.groups.map(a),privateChatsWith:r.privateChatsWith.map(a)}})},[t.id,b]),at=(0,r.useCallback)(e=>{const s=Ae.current,r=!s||s.scrollHeight-s.scrollTop-s.clientHeight<300,a=JSON.parse(e.body);if(console.log("%c LIVE MSG (WebSocket) RAW DATA:","color: green; font-weight: bold;",a),console.log("Received WebSocket Message:",a),"STATUS_UPDATE"===a.type){const{status:e,chatId:t,messageIds:s}=a;return void T(r=>{const n="group"===(null===b||void 0===b?void 0:b.type)?a.groupId:t,l=r[n]||[],i=e.toLowerCase(),o=l.map(e=>{if(s.includes(e.messageId)){if("seen"===i)return{...e,status:"seen"};if("delivered"===i&&"sent"===e.status)return{...e,status:"delivered"}}return e});return{...r,[n]:o}})}if("PIN_UPDATE"===a.type){const e=a.payload,s=e.groupId||(e.sender===t.id?e.receiver:e.sender);return void((null===b||void 0===b?void 0:b.chatId)===s&&X(e))}if("UNPIN_UPDATE"===a.type){const e=a.payload;let s;return s="group"===b.type?e.groupId:e.senderId===t.id?e.receiverId:e.senderId,void((null===b||void 0===b?void 0:b.chatId)===s&&X(null))}const n=a,l=n.groupId||(n.sender===t.id?n.receiver:n.sender);if(!l)return void console.warn("Received message without a clear chat ID",n);if(n.isDeleted||"deleted"===n.type)return void T(e=>{const t=e[l]||[];let s=!1;if(t.length>0){const e=t[t.length-1];s=e.messageId===n.messageId||e.id===n.messageId}const r=t.map(e=>e.messageId===n.messageId||e.id===n.messageId?{...e,type:"deleted",content:"This message was deleted",fileName:null,fileSize:null,isDeleted:!0}:e);if(s){const e=r.length>0?r[r.length-1]:null;rt(l,e)}return{...e,[l]:r}});if(n.isEdited)return void T(e=>{const t=e[l]||[],s=t.map(e=>{if(e.messageId===n.id||e.messageId===n.messageId){const s={...e,content:n.content,isEdited:!0};return t.length>0&&t[t.length-1].messageId===e.messageId&&rt(l,s),s}return e});return{...e,[l]:s}});h(n);T(e=>{const s=e[l]||[],r=n.messageId||n.id;if(s.some(e=>e.messageId===r&&"sent"===e.status))return e;let a=[...s],i=!1,o=null;const c=n.sender===t.id&&n.client_id,d=n.sender===t.id&&!n.client_id,u=n.sender!==t.id;if(c){const e=a.findIndex(e=>e.id===n.client_id);if(e>-1){const t=h(n);a[e]={...a[e],...t,status:"sent"},o=a[e],i=!0}}else if(d){const e=a.findLastIndex(e=>"sending"===e.status&&e.sender===t.id);if(e>-1){const t=h(n);a[e]={...a[e],...t,status:"sent"},o=a[e],i=!0}else if(!s.some(e=>e.messageId===r)){const e=h(n);a.push(e),o=e,i=!0}}else if(u&&!s.some(e=>e.messageId===r)){const e=h(n);a.push(e),o=e,i=!0,Re&&ze(e=>e+1)}return i?(rt(l,o),{...e,[l]:a}):e});a.sender!==t.id&&!a.isEdited&&!a.isDeleted&&"deleted"!==a.type&&r&&setTimeout(()=>tt("smooth"),100)},[t.id,rt,b,Re]),nt=(0,r.useMemo)(()=>[...i.privateChatsWith.filter(e=>e.chatId!==(null===t||void 0===t?void 0:t.id)),...i.groups].sort((e,t)=>new Date(t.lastMessageTimestamp)-new Date(e.lastMessageTimestamp)),[i,t.id]),lt=(0,r.useCallback)(e=>{const s=JSON.parse(e.body);if(s.senderId===t.id)return;const r="TEAM"===s.type?s.groupId:s.senderId;if(!r)return;const a=nt.find(e=>e.chatId===s.senderId),n=(null===a||void 0===a?void 0:a.name)||"Someone";Se(e=>{const t={...e};return We.current[r]&&clearTimeout(We.current[r]),s.typing?(t[r]=`${n} is typing...`,We.current[r]=setTimeout(()=>{Se(e=>{const t={...e};return delete t[r],t})},3e3)):delete t[r],t})},[t.id,nt]);(0,r.useEffect)(()=>{Xe.current=at}),(0,r.useEffect)(()=>{!M&&Ae.current&&tt("auto")},[M,b]),(0,r.useEffect)(()=>{if(null===t||void 0===t||!t.id||!ye)return;if(Ue.current)return;const e=`ws://hrms.anasolconsultancyservices.com/api/chat?employeeId=${t.id}`,s=new p.K({brokerURL:e,reconnectDelay:5e3,onConnect:()=>{je(!0);const e=e=>{Xe.current&&Xe.current(e)};Qe.current.private=s.subscribe("/user/queue/private",e),Qe.current["private-ack"]=s.subscribe("/user/queue/private-ack",e),Qe.current["group-ack"]=s.subscribe("/user/queue/group-ack",e),Qe.current.presence=s.subscribe("/topic/presence",e=>{const s=JSON.parse(e.body);s.userId!==t.id&&o(e=>{const t=e.privateChatsWith.map(e=>e.chatId===s.userId?{...e,isOnline:s.isOnline}:e);return{...e,privateChatsWith:t}})}),Qe.current.typing=s.subscribe("/user/queue/typing-status",lt)},onWebSocketError:e=>console.error("WebSocket Error:",e),onStompError:e=>console.error("STOMP Error:",e.headers.message,e.body),onWebSocketClose:()=>{je(!1)}});return s.activate(),Ue.current=s,()=>{var e;null!==(e=Ue.current)&&void 0!==e&&e.active&&(Ue.current.deactivate(),Ue.current=null)}},[null===t||void 0===t?void 0:t.id,ye]);const it=(0,r.useMemo)(()=>(i.groups||[]).map(e=>e.chatId).sort().join(","),[i.groups]);(0,r.useEffect)(()=>{var e;if(!be||null===(e=Ue.current)||void 0===e||!e.active)return;const t=e=>{Xe.current&&Xe.current(e)},s=new Set((i.groups||[]).map(e=>e.chatId.toString())),r=Object.keys(Qe.current),a=new Set(r.filter(e=>e.startsWith("group-")).map(e=>e.replace("group-","")));a.forEach(e=>{if(!s.has(e)){const t=`group-${e}`;Qe.current[t]&&(Qe.current[t].unsubscribe(),delete Qe.current[t])}}),s.forEach(e=>{if(!a.has(e)){const s=`group-${e}`;Qe.current[s]=Ue.current.subscribe(`/topic/team-${e}`,t);const r=`group-typing-${e}`;Qe.current[r]=Ue.current.subscribe(`/topic/typing-status/${e}`,lt)}})},[be,it,i.groups,me,t.id]);const ot=(0,r.useCallback)(e=>{var s;if(null===t||void 0===t||!t.id||null===(s=Ue.current)||void 0===s||!s.active)return;const r=`/app/presence/open/${e.chatId}`,a={userId:t.id,type:"group"===e.type?"TEAM":"PRIVATE"};Ue.current.publish({destination:r,body:JSON.stringify(a)}),S(e),D(!0);const n=`/chat/${t.id}/with?id=${e.chatId}`;window.history.pushState({path:n},"",n)},[t.id]),ct=(0,r.useCallback)(()=>{var e;if(!b||null===(e=Ue.current)||void 0===e||!e.active||null===t||void 0===t||!t.id)return;const s=`/app/presence/close/${b.chatId}`;Ue.current.publish({destination:s,body:"{}"}),S(null),D(!1);const r=`/chat/${t.id}`;window.history.pushState({path:r},"",r)},[b,t.id]),dt=(0,r.useCallback)(e=>{(e.unreadMessageCount||0)>0&&o(t=>({...t,groups:t.groups.map(t=>t.chatId===e.chatId?{...t,unreadMessageCount:0}:t),privateChatsWith:t.privateChatsWith.map(t=>t.chatId===e.chatId?{...t,unreadMessageCount:0}:t)})),b&&(b.chatId,e.chatId),ot(e)},[b,ot]);(0,r.useEffect)(()=>{const e=()=>{if(b&&Ue.current&&Ue.current.active){const e=`/app/presence/close/${b.chatId}`;Ue.current.publish({destination:e,body:"{}"})}};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[b]),(0,r.useEffect)(()=>{(async()=>{if(oe&&b&&"group"===b.type&&(console.log("Group Info useEffect running. Tab:",de,"Current members count:",me.length),"Members"===de&&0===me.length))try{pe(!0),console.log("Fetching members for team ID:",b.chatId);const e=await(async e=>{try{const t=await d.get(`/chat/team/employee/${e}`);return console.log("Response:",t),t.data}catch(t){return console.error(`Failed to fetch members for team ${e}:`,t),null}})(b.chatId);console.log("API response from getGroupMembers:",e);const t=Array.isArray(e)&&e.length>0?e[0]:null;t&&t.employees?(console.log("Setting group members state with:",t.employees),ge(t.employees)):(console.log("No 'employees' array found in the final object. Setting empty array."),ge([]))}catch(e){console.error("Failed to fetch group members:",e),ge([])}finally{pe(!1)}})()},[oe,de,b,me.length]),(0,r.useEffect)(()=>{const e=e=>{var t,s,r;!F||!Ve.current||Ve.current.contains(e.target)||null!==(t=qe.current)&&void 0!==t&&t.contains(e.target)||z(!1),!U||!He.current||He.current.contains(e.target)||null!==(s=Ye.current)&&void 0!==s&&s.contains(e.target)||W(!1),B.visible&&_e.current&&!_e.current.contains(e.target)&&V({visible:!1,x:0,y:0,message:null,index:null}),!ae||!Ge.current||Ge.current.contains(e.target)||null!==(r=Je.current)&&void 0!==r&&r.contains(e.target)||ne(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[F,U,B.visible,ae]);const ut=e=>{var s;if(null===(s=Ue.current)||void 0===s||!s.active||!b)return;const r={senderId:t.id,typing:e,type:"group"===b.type?"TEAM":"PRIVATE",receiverId:"private"===b.type?b.chatId:null,groupId:"group"===b.type?b.chatId:null};Ue.current.publish({destination:"/app/typing",body:JSON.stringify(r)})},mt=()=>{if(!k.trim()||!b)return;ut(!1);const e=Date.now().toString()+Math.random().toString(36).substring(2,9),s=null!==Y,r={id:e,messageId:e,sender:t.id,content:k,timestamp:(new Date).toISOString(),status:"sending",type:"text",fileName:null,fileSize:null,isEdited:!1,replyTo:Y,isForwarded:!1};let a,n;rt(b.chatId,r),T(e=>({...e,[b.chatId]:[...e[b.chatId]||[],r]})),s?(a="/app/reply",n={replyToMessageId:Y.messageId,sender:t.id,content:k,clientId:e,receiver:"private"===b.type?b.chatId:null,groupId:"group"===b.type?b.chatId:null,type:"group"===b.type?"TEAM":"PRIVATE"}):(a="/app/send",n={sender:t.id,content:k,type:"group"===b.type?"TEAM":"PRIVATE",receiver:"private"===b.type?b.chatId:null,groupId:"group"===b.type?b.chatId:null,clientId:e}),Ue.current.publish({destination:a,body:JSON.stringify(n)}),C(""),z(!1),_(null),setTimeout(()=>tt("smooth"),100)},gt=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});A(!0),Be.current=[];const s=new MediaRecorder(e,{mimeType:"audio/webm"});s.ondataavailable=e=>{e.data.size>0&&Be.current.push(e.data)},s.onstop=async()=>{if(e.getTracks().forEach(e=>e.stop()),!b||0===Be.current.length)return;const s=new Blob(Be.current,{type:"audio/webm"});console.log("Local Audio Blob created:",s);const r=URL.createObjectURL(s);console.log("You can manually open this local URL to test:",r);const a=document.createElement("a");a.style.display="none",a.href=r,a.download="test-recording.webm",document.body.appendChild(a),a.click(),document.body.removeChild(a);const n=new File([s],`voice-message-${Date.now()}.webm`,{type:"audio/webm"}),l=await(e=>new Promise(t=>{const s=new FileReader;s.onload=e=>{const s=new(window.AudioContext||window.webkitAudioContext);s.decodeAudioData(e.target.result,e=>{const r=e.duration?Math.round(e.duration):0;s.close(),t(r)},e=>{console.error("Error decoding audio data:",e),s.close(),t(0)})},s.onerror=e=>{console.error("Error reading blob as ArrayBuffer:",e),t(0)},s.readAsArrayBuffer(e)}))(s),i=new FileReader;i.readAsDataURL(s),i.onloadend=async()=>{const e=i.result,r=Date.now().toString()+Math.random().toString(36).substring(2,9),a=URL.createObjectURL(s),o={id:r,messageId:r,sender:t.id,content:a,timestamp:(new Date).toISOString(),status:"sending",type:"audio",fileName:n.name,fileSize:n.size,fileUrl:a,isEdited:!1,duration:l};rt(b.chatId,o),T(e=>({...e,[b.chatId]:[...e[b.chatId]||[],o]}));const c={sender:t.id,clientId:r,fileType:n.type,fileName:n.name,fileData:e,type:"group"===b.type?"TEAM":"PRIVATE",groupId:"group"===b.type?b.chatId:null,receiver:"private"===b.type?b.chatId:null,duration:l};try{await(async e=>{try{const t=await d.post("/chat/voice/upload",e);return console.log("Response:",t),t.data}catch(t){throw console.error("Voice message upload failed:",t),t}})(c)}catch(u){console.error("Voice message upload failed:",u),T(e=>{const t=(e[b.chatId]||[]).map(e=>e.id===r?{...e,status:"failed"}:e);return{...e,[b.chatId]:t}})}}},Oe.current=s,Oe.current.start()}catch(e){console.error("Mic error:",e),A(!1)}},ht=()=>{Oe.current&&"recording"===Oe.current.state&&(Oe.current.stop(),A(!1))},pt=()=>{var e;const s=k.trim();if(""===s||null===q.index||null===(e=Ue.current)||void 0===e||!e.active)return void ft();const r=b.chatId,a=$[r],n=a[q.index],l=n.messageId;if(s===q.originalContent||"number"!==typeof l)return void ft();const i={...n,content:s,isEdited:!0},o=a.map((e,t)=>t===q.index?i:e);T(e=>({...e,[r]:o})),q.index===a.length-1&&rt(r,i);const c={messageId:l,content:s,sender:t.id};Ue.current.publish({destination:"/app/edit",body:JSON.stringify(c)}),ft()},ft=()=>{H({index:null,originalContent:""}),C("")},xt=async e=>{const s=b.chatId,r=[...$[s]||[]],a=r[B.index],n=null===a||void 0===a?void 0:a.messageId;if(!n||"number"!==typeof n||"sending"===a.status||"failed"===a.status)return console.error("Invalid messageId or message status for deletion:",n,a.status),void V({visible:!1,x:0,y:0,message:null,index:null});try{if(e)await(async(e,t)=>{try{const s=await d.post(`/chat/${e}/everyone?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to delete message ${e} for everyone:`,s),s}})(n,t.id);else{await(async(e,t)=>{try{const s=await d.post(`/chat/${e}/me?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to delete message ${e} for me:`,s),s}})(n,t.id);const e=r.filter((e,t)=>t!==B.index);T(t=>({...t,[s]:e}));const a=e.length>0?e[e.length-1]:null;rt(s,a)}}catch(l){console.error(`Failed to delete message ${n} in component:`,l)}finally{V({visible:!1,x:0,y:0,message:null,index:null})}},yt=()=>{if(!Z)return;const e=[...$[b.chatId]];e[Z.index]=Z.message,T(t=>({...t,[b.chatId]:e})),G(null)},vt=()=>{if(ne(!1),J){const e=kt.findIndex(e=>e.messageId===J.messageId);if(-1!==e){const t=document.querySelector(`[data-message-index='${e}']`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("animate-pulse","bg-blue-200"),setTimeout(()=>t.classList.remove("animate-pulse","bg-blue-200"),2500))}}},bt=nt.filter(e=>{var t;return null===(t=e.name)||void 0===t?void 0:t.toLowerCase().includes(c.toLowerCase())});(0,r.useEffect)(()=>{if(et&&nt.length>0&&be&&!b){const e=nt.find(e=>e.chatId.toString()===et);e?(console.log("SUCCESS: All conditions met. Selecting chat from URL:",e),dt(e)):console.warn(`WARN: Chat with ID ${et} not found in the chat list.`)}},[nt,et,b,dt,be]);const jt=e=>{if(!e)return"";const t=new Date(e.endsWith("Z")?e:e+"Z");return isNaN(t)?"":t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0})},wt=e=>{if(!e)return"";const t=new Date(String(e).endsWith("Z")?e:e+"Z");if(isNaN(t))return"Invalid Date";const s=new Date,r=new Date(s);return r.setDate(r.getDate()-1),t.toDateString()===s.toDateString()?"Today":t.toDateString()===r.toDateString()?"Yesterday":t.toLocaleDateString([],{year:"numeric",month:"long",day:"numeric"})},Nt=e=>{switch(e){case"sending":return"ring-yellow-400";case"sent":return"ring-gray-400";case"delivered":return"ring-blue-500";case"seen":return"ring-green-500";case"failed":return"ring-red-500";default:return"ring-transparent"}};let It=null;const St=b?nt.find(e=>e.chatId===b.chatId):null,kt=St&&$[St.chatId]||[],Ct=e=>{if(!t)return{name:"Unknown",profile:null};if(e===t.id)return{name:"You",profile:t.profile};const s=[...i.privateChatsWith,...(null===St||void 0===St?void 0:St.members)||[]].find(t=>t.chatId===e||t.employeeId===e);return s?{name:s.name||s.employeeName,profile:s.profile||null}:{name:"Unknown User",profile:null}},$t=e=>{const t=d.defaults.baseURL;if(e.fileUrl&&e.fileUrl.startsWith("blob:"))return e.fileUrl;if(e.fileUrl&&e.fileUrl.startsWith("/api")){return`${new URL(t).origin}${e.fileUrl}`}if(e.fileUrl)return e.fileUrl;const s=e.id||e.messageId;return s?`${t}/chat/file/${s}`:e.content};return(0,v.jsxs)("div",{className:"w-full h-full bg-gray-100 font-sans",children:[(0,v.jsxs)("div",{className:"flex w-full h-full p-0 md:p-4 md:gap-4",children:[(0,v.jsxs)("div",{className:"relative w-full md:w-[30%] h-full p-4 bg-white flex flex-col shadow-xl md:rounded-lg "+(R?"hidden md:flex":"flex"),children:[(0,v.jsx)("div",{className:"mb-4 flex-shrink-0",children:(0,v.jsx)("input",{type:"text",placeholder:"Search chats or users...",className:"w-full p-3 rounded-lg border border-gray-300 bg-gray-50",value:c,onChange:e=>m(e.target.value)})}),(0,v.jsxs)("div",{ref:Le,onScroll:()=>{const e=Le.current;if(e){const{scrollTop:t,scrollHeight:s,clientHeight:r}=e;s-t-r<100&&(console.log(`Scroll condition met. isFetchingMore: ${l}, hasMore: ${n}`),n&&!l&&a())}},className:"flex-grow space-y-2 pr-2 overflow-y-auto custom-scrollbar",children:[bt.map(e=>(0,v.jsxs)("div",{onClick:()=>dt(e),className:"p-3 flex items-center rounded-lg cursor-pointer group "+((null===b||void 0===b?void 0:b.chatId)===e.chatId?"bg-blue-100":"hover:bg-blue-50"),children:[(0,v.jsxs)("div",{className:"relative flex-shrink-0",children:["group"===e.type?(0,v.jsx)("div",{className:"w-11 h-11 rounded-full bg-gray-200 flex items-center justify-center",children:(0,v.jsx)(f.YXz,{className:"text-gray-500",size:24})}):e.profile?(0,v.jsx)("img",{src:e.profile,alt:e.name,className:"w-11 h-11 rounded-full object-cover"}):(0,v.jsx)("div",{className:"w-11 h-11 rounded-full bg-gray-200 flex items-center justify-center",children:(0,v.jsx)(f.x$1,{className:"text-gray-500",size:24})}),e.isOnline&&(0,v.jsx)("span",{className:"absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-green-500"})]}),(0,v.jsxs)("div",{className:"flex-1 min-w-0 mx-3",children:[(0,v.jsx)("p",{className:"font-semibold text-gray-800 truncate",children:e.name}),(0,v.jsx)("p",{className:"text-sm text-gray-500 truncate",children:e.lastMessage||"No messages yet"})]}),(e.unreadMessageCount||0)>0&&(0,v.jsx)("div",{className:"flex-shrink-0",children:(0,v.jsx)("span",{className:"bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full",children:e.unreadMessageCount})})]},e.chatId)),l&&(0,v.jsx)("div",{className:"flex justify-center items-center p-4",children:(0,v.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})})]})]}),(0,v.jsx)("div",{className:"w-full md:w-[70%] h-full flex flex-col bg-white md:rounded-lg shadow-xl relative "+(R?"flex":"hidden md:flex"),children:St?(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200",children:[(0,v.jsxs)("div",{className:"flex items-center space-x-3 flex-grow min-w-0",children:[(0,v.jsx)("button",{onClick:ct,className:"md:hidden p-2 rounded-full hover:bg-gray-100",children:(0,v.jsx)(f.QVr,{})}),(0,v.jsx)("button",{onClick:()=>"group"!==St.type&&St.profile&&ie(!0),className:"flex-shrink-0",children:"group"===St.type?(0,v.jsx)("div",{className:"w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center",children:(0,v.jsx)(f.YXz,{className:"text-gray-500",size:28})}):St.profile?(0,v.jsx)("img",{src:St.profile,alt:St.name,className:"w-12 h-12 rounded-full object-cover"}):(0,v.jsx)("div",{className:"w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center",children:(0,v.jsx)(f.x$1,{className:"text-gray-500",size:28})})}),(0,v.jsxs)("div",{className:"truncate",children:[(0,v.jsx)("button",{onClick:()=>{"group"===(null===b||void 0===b?void 0:b.type)&&(ue("Overview"),ge([]),ce(!0))},disabled:"group"!==St.type,className:"text-left",children:(0,v.jsx)("p",{className:"font-bold text-lg truncate",children:St.name})}),"private"===St.type?(0,v.jsx)("p",{className:"text-sm text-gray-500",children:St.isOnline?"Online":(e=>{if(!e)return"Offline";const t=new Date(String(e).endsWith("Z")?e:e+"Z");if(isNaN(t))return"Offline";const s=new Date;return t.toDateString()===s.toDateString()?`last seen today at ${jt(e)}`:`last seen on ${t.toLocaleDateString()}`})(St.lastMessageTimestamp)}):(0,v.jsxs)("p",{className:"text-sm text-gray-500",children:[St.memberCount||0," members"]})]})]}),(0,v.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,v.jsx)("button",{className:"p-2 rounded-full hover:bg-gray-100 text-gray-600",children:(0,v.jsx)(f.HiP,{size:20})}),(0,v.jsx)("button",{className:"p-2 rounded-full hover:bg-gray-100 text-gray-600",children:(0,v.jsx)(f.Cab,{size:20})}),(0,v.jsxs)("div",{className:"relative",children:[(0,v.jsx)("button",{ref:Ye,onClick:()=>W(!U),className:"p-2 rounded-full hover:bg-gray-100",children:(0,v.jsx)(x.mqA,{size:20})}),U&&(0,v.jsx)("div",{ref:He,className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20",children:(0,v.jsx)("button",{onClick:()=>{Ne(!0),W(!1)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",children:"Clear chat"})})]})]})]}),J&&(0,v.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-2 border-b border-gray-200 bg-gray-50",children:[(0,v.jsxs)("div",{className:"flex items-center gap-2 text-sm overflow-hidden cursor-pointer flex-grow min-w-0",onClick:vt,children:[(0,v.jsx)(f.LBY,{className:"text-gray-500 flex-shrink-0"}),(0,v.jsx)(j,{fileName:J.fileName||"",type:J.messageType,className:"text-lg flex-shrink-0"}),(0,v.jsxs)("div",{className:"truncate",children:[(0,v.jsx)("p",{className:"font-bold text-blue-600",children:"Pinned Message"}),(0,v.jsx)("p",{className:"text-gray-600 truncate",children:"text"===J.messageType?J.content:J.fileName||"Pinned Media"})]})]}),(0,v.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,v.jsx)("button",{ref:Je,onClick:()=>ne(!ae),className:"p-2 rounded-full hover:bg-gray-200",children:(0,v.jsx)(f.Vr3,{})}),ae&&(0,v.jsx)("div",{ref:Ge,className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 text-sm",children:(0,v.jsxs)("ul",{className:"py-1",children:[(0,v.jsxs)("li",{onClick:vt,className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3",children:[(0,v.jsx)(f.eaw,{})," Go to message"]}),(0,v.jsxs)("li",{onClick:async()=>{if(null!==J&&void 0!==J&&J.messageId)try{await(async(e,t)=>{try{const s=await d.post(`/chat/unpin/${e}?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to unpin message ${e}:`,s),s}})(J.messageId,t.id),X(null)}catch(e){console.error("Failed to unpin message:",e)}finally{ne(!1)}},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600",children:[(0,v.jsx)(f.QCr,{})," Unpin"]})]})})]})]}),(0,v.jsxs)("div",{ref:Ae,onScroll:()=>{const e=Ae.current;if(!e)return;const{scrollTop:t,scrollHeight:s,clientHeight:r}=e;if(0===t&&!M&&!Me){const e=b.chatId;if(!1!==$e[e]){const t=(ke[e]||0)+1;Ce(s=>({...s,[e]:t})),st(e,t)}}const a=s-t-r>400;a!==Re&&(De(a),a||ze(0))},className:"flex-grow p-4 overflow-y-auto bg-gray-50",children:[Me&&(0,v.jsx)("div",{className:"flex justify-center items-center py-4",children:(0,v.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}),M?(0,v.jsx)(I,{}):(0,v.jsxs)("div",{className:"space-y-2",children:[kt.map((e,s)=>{const a=e.sender===(null===t||void 0===t?void 0:t.id),n=new Date(e.timestamp).toDateString(),l=It!==n;l&&(It=n);const i=a?null:Ct(e.sender),o=$t(e);return(0,v.jsxs)(r.Fragment,{children:[l&&(0,v.jsx)("div",{className:"text-center my-4",children:(0,v.jsx)("span",{className:"bg-gray-200 text-gray-600 text-xs font-semibold px-3 py-1 rounded-full",children:wt(e.timestamp)})}),(0,v.jsxs)("div",{"data-message-index":s,className:"flex items-end gap-2 "+(a?"justify-end":"justify-start"),children:[!a&&(()=>{const e="group"===St.type?null===i||void 0===i?void 0:i.profile:St.profile,t="group"===St.type?null===i||void 0===i?void 0:i.name:St.name;return e?(0,v.jsx)("img",{src:e,alt:t,className:"w-8 h-8 rounded-full object-cover self-start flex-shrink-0"}):(0,v.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center self-start flex-shrink-0",children:(0,v.jsx)(f.x$1,{className:"text-gray-500",size:18})})})(),(0,v.jsxs)("div",{className:"flex flex-col "+(a?"items-end":"items-start"),children:["group"===St.type&&!a&&(0,v.jsx)("p",{className:"text-xs text-gray-500 mb-1 ml-2 font-semibold",children:null===i||void 0===i?void 0:i.name}),(0,v.jsx)("div",{onContextMenu:t=>((e,t,s)=>{e.preventDefault(),e.stopPropagation();let r=e.pageX,a=e.pageY;r+180>window.innerWidth&&(r-=180),a+250>window.innerHeight&&(a-=250),V({visible:!0,x:r,y:a,message:t,index:s})})(t,e,s),className:`rounded-lg max-w-xs md:max-w-md group relative\n                                                                ${"image"===e.type||"deleted"===e.type?"p-0 bg-transparent":""}\n                                                                ${"text"===e.type?a?"bg-blue-600 text-white p-3":"bg-gray-200 text-gray-800 p-3":""}\n                                                                ${"audio"===e.type||"file"===e.type?a?"bg-blue-600":"bg-gray-200":""}\n                                                                `,children:"deleted"===e.type?(0,v.jsxs)("div",{className:"flex items-center gap-2 italic text-sm opacity-70 p-3",children:[(0,v.jsx)("span",{children:"This message was deleted"}),(null===Z||void 0===Z?void 0:Z.index)===s&&(0,v.jsx)("button",{onClick:yt,className:"font-semibold hover:underline",children:"Undo"})]}):(0,v.jsxs)(v.Fragment,{children:[e.isForwarded&&(0,v.jsxs)("div",{className:"flex items-center gap-1.5 text-xs opacity-70 mb-1 font-semibold",children:[(0,v.jsx)(f.Zzu,{})," Forwarded"]}),e.replyTo&&(0,v.jsxs)("div",{className:"p-2 rounded mb-2 text-sm "+(a?"bg-blue-500":"bg-gray-300"),children:[(0,v.jsx)("p",{className:"font-semibold",children:e.replyTo.sender===(null===t||void 0===t?void 0:t.id)?"You":Ct(e.replyTo.sender).name}),(0,v.jsx)("p",{className:"opacity-80 truncate",children:(["image","audio","file"].includes(e.replyTo.type),e.replyTo.content)})]}),"image"===e.type?(0,v.jsxs)("div",{className:"relative",children:[(0,v.jsx)("button",{onClick:()=>xe(o),children:(0,v.jsx)("img",{src:o,alt:e.fileName||"image",className:"rounded-md max-w-full",style:{maxHeight:"300px"}})}),!a&&(0,v.jsx)("a",{href:o,download:e.fileName,onClick:e=>e.stopPropagation(),className:"absolute bottom-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity",children:(0,v.jsx)(f.WCW,{})})]}):"audio"===e.type?(0,v.jsx)("div",{className:(a?"bg-blue-600":"bg-gray-200")+" rounded-lg",children:(0,v.jsx)(N,{src:o,fileUrl:o,isSender:a,initialDuration:e.duration,fileSize:e.fileSize})}):"file"===e.type?(0,v.jsx)(w,{msg:e,isMyMessage:a}):(0,v.jsx)("p",{className:"text-sm break-words",children:e.content})]})}),(0,v.jsxs)("span",{className:"text-xs text-gray-400 mt-1 px-1",children:["sending"===e.status?"Sending...":"failed"===e.status?"Failed":jt(e.timestamp)," ",e.isEdited?"(edited)":""]})]}),a&&(0,v.jsx)("div",{className:"relative w-8 h-8 self-start flex-shrink-0",children:(0,v.jsx)("img",{src:(null===t||void 0===t?void 0:t.profile)||"https://placehold.co/100x100/E2E8F0/4A5568?text=Me",alt:"current user",className:`w-full h-full rounded-full object-cover ring-2 ${Nt(e.status)}`})})]})]},e.messageId||e.id)}),Ie[b.chatId]&&(0,v.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,v.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center self-start flex-shrink-0",children:(0,v.jsx)(f.x$1,{className:"text-gray-500",size:18})}),(0,v.jsx)("div",{className:"flex flex-col items-start",children:(0,v.jsx)("div",{className:"p-3 rounded-lg bg-gray-200 text-gray-800",children:(0,v.jsxs)("div",{className:"flex items-center justify-center gap-1.5",children:[(0,v.jsx)("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.3s]"}),(0,v.jsx)("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.15s]"}),(0,v.jsx)("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce"})]})})})]})]})]}),(0,v.jsxs)("div",{className:"flex-shrink-0 flex flex-col p-4 border-t border-gray-200",children:[Y&&(0,v.jsxs)("div",{className:"bg-gray-100 p-2 rounded-t-lg flex justify-between items-center",children:[(0,v.jsxs)("div",{className:"text-sm overflow-hidden",children:[(0,v.jsxs)("p",{className:"font-semibold text-blue-600",children:["Replying to ",Y.sender===(null===t||void 0===t?void 0:t.id)?"yourself":Ct(Y.sender).name]}),(0,v.jsx)("p",{className:"text-gray-600 truncate",children:["image","audio","file"].includes(Y.type)?Y.fileName:Y.content})]}),(0,v.jsx)("button",{onClick:()=>_(null),children:(0,v.jsx)(f.QCr,{})})]}),null!==q.index&&(0,v.jsxs)("div",{className:"bg-gray-100 p-2 rounded-t-lg flex justify-between items-center",children:[(0,v.jsxs)("div",{className:"text-sm overflow-hidden",children:[(0,v.jsx)("p",{className:"font-semibold text-blue-600",children:"Editing message"}),(0,v.jsx)("p",{className:"text-gray-600 truncate",children:q.originalContent})]}),(0,v.jsx)("button",{onClick:ft,children:(0,v.jsx)(f.QCr,{})})]}),St&&(0,v.jsxs)("div",{className:"relative flex items-center w-full space-x-2 "+(Y||null!==q.index?"pt-2":""),children:[F&&(0,v.jsx)("div",{ref:Ve,className:"absolute bottom-full mb-2 left-0 z-40 w-[95vw] max-w-sm",children:(0,v.jsx)(y.Ay,{onEmojiClick:e=>C(t=>t+e.emoji),width:"100%",height:350})}),(0,v.jsxs)("div",{className:"relative flex-grow",children:[(0,v.jsx)("input",{ref:Ze,type:"text",placeholder:L?"Recording...":"Type a message...",className:"w-full p-3 pr-24 rounded-full border bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",value:k,onChange:e=>{C(e.target.value),ut(!0)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),null!==q.index?pt():mt())},disabled:L}),(0,v.jsxs)("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[(0,v.jsx)("button",{ref:qe,onClick:()=>z(!F),className:"p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100",children:(0,v.jsx)(f.Ky9,{size:20})}),(0,v.jsx)("button",{onClick:()=>Pe.current.click(),className:"p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100",children:(0,v.jsx)(f.EHs,{size:20})})]})]}),k.trim()||null!==q.index?(0,v.jsx)("button",{onClick:null!==q.index?pt:mt,className:"p-3 rounded-full text-white "+(null!==q.index?"bg-green-600 hover:bg-green-700":"bg-blue-600 hover:bg-blue-700"),children:null!==q.index?(0,v.jsx)(f.CMH,{size:20}):(0,v.jsx)(f.Cer,{size:20})}):(0,v.jsx)("button",{onClick:()=>{L?ht():gt()},className:"p-3 rounded-full hover:bg-gray-100 "+(L?"text-red-500 animate-pulse":"text-gray-500 hover:text-blue-600"),children:L?(0,v.jsx)(f.wFo,{size:20}):(0,v.jsx)(f.i0t,{size:20})}),(0,v.jsx)("input",{type:"file",ref:Pe,onChange:async e=>{const s=e.target.files[0];if(!s||!b)return;let r="file";s.type.startsWith("image/")?r="image":s.type.startsWith("audio/")&&(r="audio");const a=Date.now().toString()+Math.random().toString(36).substring(2,9),n=URL.createObjectURL(s),l={id:a,messageId:a,sender:t.id,content:n,timestamp:(new Date).toISOString(),status:"sending",type:r,fileName:s.name,fileSize:s.size,fileUrl:n,isEdited:!1};rt(b.chatId,l),T(e=>({...e,[b.chatId]:[...e[b.chatId]||[],l]}));const i=new FormData;i.append("file",s),i.append("sender",t.id),i.append("client_id",a),i.append("fileType",s.type),i.append("type","group"===b.type?"TEAM":"PRIVATE"),"group"===b.type?i.append("groupId",b.chatId):i.append("receiver",b.chatId);try{await(async e=>{try{const t=await d.post("/chat/upload",e,{headers:{"Content-Type":"multipart/form-data"}});return console.log("Response:",t),t.data}catch(t){throw console.error("File upload failed:",t),t}})(i)}catch(o){console.error("File upload failed in component:",o),T(e=>{const t=(e[b.chatId]||[]).map(e=>e.id===a?{...e,status:"failed"}:e);return{...e,[b.chatId]:t}})}finally{e.target.value=null}},className:"hidden"})]})]})]}):(0,v.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,v.jsxs)("div",{className:"text-center",children:[(0,v.jsx)(f.YXz,{className:"mx-auto text-6xl text-gray-300"}),(0,v.jsx)("p",{className:"mt-4 text-xl text-center text-gray-600",children:"Select a chat to begin"}),(0,v.jsx)("p",{className:"text-gray-400",children:"Start a conversation with your team or colleagues."})]})})}),Re&&(0,v.jsxs)("button",{onClick:()=>tt(),className:"absolute bottom-24 right-8 z-10 bg-blue-600/80 backdrop-blur-sm text-white rounded-full p-3 shadow-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:scale-110 animate-fade-in","aria-label":"Scroll to bottom",children:[Fe>0&&(0,v.jsx)("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center",children:Fe>9?"9+":Fe}),(0,v.jsx)(f.Vr3,{size:20})]})]}),B.visible&&(0,v.jsx)("div",{ref:_e,style:{top:B.y,left:B.x},className:"absolute bg-white rounded-md shadow-lg z-50 text-sm",children:(0,v.jsx)("ul",{className:"py-1",children:"deleted"===B.message.type?(0,v.jsxs)("li",{onClick:()=>xt(!1),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600",children:[(0,v.jsx)(f.qbC,{})," Delete for me"]}):(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("li",{onClick:()=>{_(B.message),V({visible:!1,x:0,y:0,message:null,index:null}),Ze.current.focus()},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3",children:[(0,v.jsx)(f.w1Z,{})," Reply"]}),(0,v.jsxs)("li",{onClick:async()=>{var e;if(null!==(e=B.message)&&void 0!==e&&e.messageId)try{const e=B.message.messageId,s=await(async(e,t)=>{try{const s=await d.post(`/chat/pin/${e}?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to pin message ${e}:`,s),s}})(e,t.id);X(s)}catch(s){console.error("Failed to pin message:",s)}finally{V({visible:!1,x:0,y:0,message:null,index:null})}},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3",children:[(0,v.jsx)(f.LBY,{})," Pin"]}),(0,v.jsxs)("li",{onClick:()=>{Q({visible:!0,message:B.message}),V({visible:!1,x:0,y:0,message:null,index:null})},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3",children:[(0,v.jsx)(f.Zzu,{})," Forward"]}),"sending"!==B.message.status&&"failed"!==B.message.status&&(0,v.jsxs)(v.Fragment,{children:[B.message.sender===(null===t||void 0===t?void 0:t.id)&&"text"===B.message.type&&!B.message.isForwarded&&new Date-new Date(B.message.timestamp)<9e5&&(0,v.jsxs)("li",{onClick:()=>{H({index:B.index,originalContent:B.message.content}),C(B.message.content),V({visible:!1,x:0,y:0,message:null,index:null}),Ze.current.focus()},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3",children:[(0,v.jsx)(f.uO9,{})," Edit"]}),(0,v.jsx)("hr",{className:"my-1"}),(0,v.jsxs)("li",{onClick:()=>xt(!1),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600",children:[(0,v.jsx)(f.qbC,{})," Delete for me"]}),B.message.sender===(null===t||void 0===t?void 0:t.id)&&(0,v.jsxs)("li",{onClick:()=>xt(!0),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600",children:[(0,v.jsx)(f.qbC,{})," Delete for everyone"]})]})]})})}),K.visible&&(0,v.jsx)("div",{className:"fixed inset-0 bg-opacity-100 flex items-center justify-center z-[100]",children:(0,v.jsxs)("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-md",children:[(0,v.jsxs)("div",{className:"p-4 border-b flex justify-between items-center",children:[(0,v.jsx)("h3",{className:"font-bold text-lg",children:"Forward message to..."}),(0,v.jsx)("button",{onClick:()=>Q({visible:!1,message:null}),children:(0,v.jsx)(f.QCr,{})})]}),(0,v.jsx)("div",{className:"p-4",children:(0,v.jsx)("input",{type:"text",placeholder:"Search for users or groups",className:"w-full p-2 border rounded-lg",value:se,onChange:e=>re(e.target.value)})}),(0,v.jsx)("div",{className:"h-64 overflow-y-auto p-4",children:nt.filter(e=>{var t;return null===(t=e.name)||void 0===t?void 0:t.toLowerCase().includes(se.toLowerCase())}).map(e=>(0,v.jsxs)("div",{className:"flex items-center p-2 rounded-lg hover:bg-gray-100",children:[(0,v.jsx)("input",{type:"checkbox",id:`fwd-${e.chatId}`,className:"mr-3 h-4 w-4 accent-blue-600",checked:ee.includes(e.chatId),onChange:t=>{t.target.checked?te([...ee,e.chatId]):te(ee.filter(t=>t!==e.chatId))}}),(0,v.jsxs)("label",{htmlFor:`fwd-${e.chatId}`,className:"flex-grow flex items-center gap-3 cursor-pointer",children:["group"===e.type?(0,v.jsx)("div",{className:"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center",children:(0,v.jsx)(f.YXz,{className:"text-gray-500"})}):(0,v.jsx)("img",{src:e.profile,alt:e.name,className:"w-10 h-10 rounded-full object-cover",onError:e=>{e.target.src="https://placehold.co/100x100/E2E8F0/4A5568?text=U"}}),(0,v.jsx)("span",{children:e.name})]})]},e.chatId))}),(0,v.jsx)("div",{className:"p-4 border-t text-right",children:(0,v.jsx)("button",{onClick:async()=>{const e=K.message;if(!e||0===ee.length)return;const s={sender:t.id,forwardMessageId:e.messageId,forwardTo:ee.map(e=>{const t=nt.find(t=>t.chatId===e);return"private"===t.type?{receiver:t.chatId}:{groupId:t.chatId}})};try{await(async e=>{try{const t=await d.post("/chat/forward",e);return console.log("Response:",t),t.data}catch(t){throw console.error(`Failed to forward message ${e.forwardMessageId}:`,t),t}})(s);const e={...K.message,sender:t.id,timestamp:(new Date).toISOString()};ee.forEach(t=>{rt(t,e)})}catch(r){console.error("Failed to forward message:",r)}finally{Q({visible:!1,message:null}),te([]),re("")}},disabled:0===ee.length,className:"bg-blue-600 text-white px-4 py-2 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer",children:"Forward"})})]})}),le&&St&&"group"!==St.type&&(0,v.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]",onClick:()=>ie(!1),children:(0,v.jsx)("img",{src:St.profile,alt:St.name,className:"max-w-[80vw] max-h-[90vh] object-contain",onClick:e=>e.stopPropagation()})}),oe&&"group"===(null===St||void 0===St?void 0:St.type)&&(0,v.jsx)("div",{className:"fixed inset-0 bg-opacity-100 flex items-center justify-center z-[100]",onClick:()=>ce(!1),children:(0,v.jsxs)("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-lg h-[80vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[(0,v.jsxs)("div",{className:"p-4 border-b flex justify-between items-center flex-shrink-0",children:[(0,v.jsx)("h3",{className:"font-bold text-xl",children:"Group Info"}),(0,v.jsx)("button",{onClick:()=>ce(!1),className:"p-2 rounded-full hover:bg-gray-200",children:(0,v.jsx)(f.QCr,{})})]}),(0,v.jsx)("div",{className:"flex border-b flex-shrink-0",children:["Overview","Members","Media","Files","Links"].map(e=>(0,v.jsx)("button",{onClick:()=>ue(e),className:"flex-1 p-3 text-sm font-semibold "+(de===e?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:bg-gray-100"),children:e},e))}),(0,v.jsxs)("div",{className:"p-4 overflow-y-auto flex-grow",children:["Overview"===de&&(0,v.jsxs)("div",{className:"flex flex-col items-center text-center space-y-4",children:[(0,v.jsx)("div",{className:"w-40 h-40 rounded-full bg-gray-200 flex items-center justify-center",children:(0,v.jsx)(f.YXz,{className:"text-gray-500",size:80})}),(0,v.jsx)("h2",{className:"text-2xl font-bold",children:St.name}),(0,v.jsxs)("p",{className:"text-gray-600",children:[St.memberCount||0," members"]})]}),"Members"===de&&(0,v.jsx)("div",{className:"space-y-3",children:he?(0,v.jsx)("p",{className:"text-center text-gray-500",children:"Loading members..."}):me.map((e,t)=>(0,v.jsxs)("div",{className:"flex items-center gap-4 p-2 rounded-lg hover:bg-gray-50",children:[e.employeeImage?(0,v.jsx)("img",{src:e.employeeImage,alt:e.displayName,className:"w-10 h-10 rounded-full object-cover"}):(0,v.jsx)("div",{className:"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center",children:(0,v.jsx)(f.x$1,{className:"text-gray-500",size:20})}),(0,v.jsxs)("div",{children:[(0,v.jsx)("span",{className:"font-semibold",children:e.displayName}),e.jobTitlePrimary&&(0,v.jsx)("p",{className:"text-sm text-gray-500",children:e.jobTitlePrimary})]})]},e.employeeId||t))}),"Media"===de&&(0,v.jsx)("div",{className:"grid grid-cols-3 md:grid-cols-4 gap-2",children:kt.filter(e=>["image","video"].includes(e.type)).map((e,t)=>(0,v.jsx)("button",{onClick:()=>xe($t(e)),children:(0,v.jsx)("img",{src:$t(e),alt:e.fileName,className:"w-full h-24 object-cover rounded-md cursor-pointer hover:opacity-80"})},t))}),"Files"===de&&(0,v.jsx)("div",{className:"space-y-3",children:(()=>{const e=kt.filter(e=>"file"===e.type);return e.length>0?e.map(e=>(0,v.jsx)(w,{msg:e,isMyMessage:!1},e.id)):(0,v.jsx)("p",{className:"text-center text-gray-500 p-4",children:"No files found in this chat."})})()}),"Links"===de&&(0,v.jsx)("div",{className:"space-y-3",children:(()=>{const e=kt.filter(e=>"text"===e.type&&(e.content.includes("http://")||e.content.includes("https://"))).flatMap(e=>{const t=e.content.match(/(https?:\/\/[^\s]+)/g);return t?t.map(t=>({id:e.id,url:t,sender:Ct(e.sender).name,timestamp:e.timestamp})):[]});return e.length>0?e.map((e,t)=>(0,v.jsxs)("div",{className:"p-3 bg-gray-100 rounded-lg",children:[(0,v.jsx)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline break-all",children:e.url}),(0,v.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Shared by ",e.sender," on ",new Date(e.timestamp).toLocaleDateString()]})]},`${e.id}-${t}`)):(0,v.jsx)("p",{className:"text-center text-gray-500 p-4",children:"No links found in this chat."})})()})]})]})}),fe&&(0,v.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[120]",onClick:()=>xe(null),children:(0,v.jsx)("img",{src:fe,alt:"Full view",className:"max-w-[90vw] max-h-[90vh] object-contain",onClick:e=>e.stopPropagation()})}),we&&(0,v.jsx)("div",{className:"fixed inset-0 bg-opacity-100 flex items-center justify-center z-[110]",children:(0,v.jsxs)("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-sm",children:[(0,v.jsx)("h3",{className:"text-lg font-bold mb-4",children:"Clear Chat?"}),(0,v.jsx)("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to clear all messages in this chat? This action cannot be undone."}),(0,v.jsxs)("div",{className:"flex justify-end gap-4",children:[(0,v.jsx)("button",{onClick:()=>Ne(!1),className:"px-4 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300",children:"Cancel"}),(0,v.jsx)("button",{onClick:async()=>{if(b)try{await(async(e,t)=>{try{const s=await d.post(`/chat/clear?userId=${e}&chatId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to clear chat for ${t}:`,s),s}})(t.id,b.chatId),T(e=>({...e,[b.chatId]:[]})),rt(b.chatId,null)}catch(e){console.error("Failed to clear chat:",e)}finally{Ne(!1)}},className:"px-4 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700",children:"Clear Chat"})]})]})})]})},k=()=>(0,v.jsxs)("div",{className:"flex items-center space-x-4 p-3",children:[(0,v.jsx)("div",{className:"w-11 h-11 bg-gray-200 rounded-full animate-pulse"}),(0,v.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,v.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4 animate-pulse"}),(0,v.jsx)("div",{className:"h-3 bg-gray-200 rounded w-1/2 animate-pulse"})]})]}),C=()=>(0,v.jsxs)("div",{className:"flex w-full h-full p-0 md:p-4 md:gap-4",children:[(0,v.jsxs)("div",{className:"w-full md:w-[30%] h-full p-4 bg-white flex flex-col shadow-xl md:rounded-lg space-y-4",children:[(0,v.jsx)("div",{className:"h-12 bg-gray-200 rounded-lg animate-pulse mb-4"}),(0,v.jsxs)("div",{className:"flex-grow space-y-2 pr-2 overflow-hidden",children:[(0,v.jsx)(k,{}),(0,v.jsx)(k,{}),(0,v.jsx)(k,{}),(0,v.jsx)(k,{}),(0,v.jsx)(k,{}),(0,v.jsx)(k,{}),(0,v.jsx)(k,{})]})]}),(0,v.jsx)("div",{className:"hidden md:flex flex-col w-[70%] h-full bg-white md:rounded-lg shadow-xl",children:(0,v.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,v.jsx)("div",{className:"text-center",children:(0,v.jsx)("p",{className:"text-xl text-gray-400",children:"Loading Chats..."})})})})]});const $=function(){const{userId:e}=(0,a.g)(),[t,s]=(0,r.useState)({groups:[],privateChatsWith:[]}),[n,l]=(0,r.useState)(!0),[i,o]=(0,r.useState)(!1),[c,u]=(0,r.useState)(0),[m,h]=(0,r.useState)(!0),p=(0,r.useRef)(!1),f={name:"You",id:e,profile:"https://placehold.co/100x100/E2E8F0/4A5568?text=Me"},x=async t=>{if(console.log(`%c loadChats function started for page: ${t}`,"color: blue; font-weight: bold;"),m&&!p.current){p.current=!0,0===t?l(!0):o(!0);try{console.log(`%c Sending API request for page: ${t}`,"color: green;");const r=await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{const r=await d.get(`/chat/overview/${e}?page=${t}&size=${s}`);return console.log(`Response for page ${t}:`,r),r.data}catch(r){return console.error("Failed to fetch chat overview:",r),[]}}(e,t,10);if(0===r.length)return void h(!1);const a=((e,t)=>{if(!e||!Array.isArray(e))return{groups:[],privateChatsWith:[]};const s={groups:[],privateChatsWith:[]};return e.forEach(e=>{const r={chatId:e.chatId,name:e.groupName||e.employeeName,lastMessage:g(e,t),lastMessageTimestamp:e.lastSeen,unreadMessageCount:e.unreadMessageCount,profile:e.profile||null,isOnline:e.isOnline,memberCount:e.memberCount||0,type:"GROUP"===e.chatType?"group":"private"};"group"===r.type?s.groups.push(r):s.privateChatsWith.push(r)}),s})(r,e);s(e=>{if(0===t)return a;const s=new Set(e.groups.map(e=>e.chatId)),r=new Set(e.privateChatsWith.map(e=>e.chatId)),n=a.groups.filter(e=>!s.has(e.chatId)),l=a.privateChatsWith.filter(e=>!r.has(e.chatId));return{groups:[...e.groups,...n],privateChatsWith:[...e.privateChatsWith,...l]}}),r.length<10&&h(!1)}catch(r){console.error("Error loading chats:",r)}finally{0===t&&l(!1),o(!1),p.current=!1,console.log(`%c Finished fetch for page ${t}. Lock released.`,"color: orange;")}}else console.log(`%c Request for page ${t} blocked. hasMore=${m}, fetchingMore.current=${p.current}`,"color: red;")};return(0,r.useEffect)(()=>{e&&x(0)},[e]),(0,v.jsx)("div",{style:{height:"90vh"},className:"flex h-screen bg-gray-100",children:n?(0,v.jsx)(C,{}):(0,v.jsx)(S,{currentUser:f,chats:t,loadMoreChats:()=>{if(console.log("handleLoadMore triggered!"),p.current||!m)return void console.log("handleLoadMore blocked by ref lock or no more data.");const e=c+1;u(e),x(e)},hasMore:m,isFetchingMore:i})})}},2397:(e,t,s)=>{s.d(t,{Pt:()=>d,bI:()=>o,qB:()=>m,vx:()=>u,yE:()=>c});var r=s(6213);let a=!1,n=[];const l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;n.forEach(s=>{e?s.reject(e):s.resolve(t)}),n=[]},i=e=>{const t=r.A.create({baseURL:e});return t.interceptors.request.use(e=>{const t=localStorage.getItem("accessToken");return t&&(e.headers.Authorization=`Bearer ${t}`),e},e=>Promise.reject(e)),t.interceptors.response.use(e=>e,async s=>{var o;const c=s.config;if(401===(null===(o=s.response)||void 0===o?void 0:o.status)&&!c._retry){if(a)return new Promise((e,t)=>{n.push({resolve:e,reject:t})}).then(e=>(c.headers.Authorization=`Bearer ${e}`,t(c))).catch(e=>Promise.reject(e));c._retry=!0,a=!0;const s=localStorage.getItem("accessToken");console.log(`\ud83d\udd34 Token expired for ${e}. Old Token:`,s);try{const t=await r.A.post("http://hrms.anasolconsultancyservices.com/api/auth/refresh-token",{},{withCredentials:!0}),{accessToken:s}=t.data;localStorage.setItem("accessToken",s),console.log(`\ud83d\udfe2 New Token for ${e}:`,s),c.data instanceof FormData&&(c.data=function(e){const t=new FormData;for(let[s,r]of e.entries())t.append(s,r);return t}(c.data)),l(null,s);const a=i(e);return c.headers.Authorization=`Bearer ${s}`,a(c)}catch(d){return console.error("Refresh token failed. Logging out.",d),localStorage.clear(),window.location.href="/login",l(d),Promise.reject(d)}finally{a=!1}}return Promise.reject(s)}),t};window.addEventListener("storage",e=>{"accessToken"===e.key&&console.log("\ud83d\udd04 Token updated in another tab:",e.newValue)});const o=i("http://hrms.anasolconsultancyservices.com/api"),c=i("http://hrms.anasolconsultancyservices.com/api"),d=i("http://hrms.anasolconsultancyservices.com/api"),u=i("http://hrms.anasolconsultancyservices.com/api/notification"),m=i("http://localhost:8088/api/ticket")}}]);
//# sourceMappingURL=654.5205f6b6.chunk.js.map