"use strict";(self.webpackChunktechlife=self.webpackChunktechlife||[]).push([[654],{654:(e,t,s)=>{s.r(t),s.d(t,{default:()=>R});var a=s(5043),r=s(3721),n=s(6213);let l=!1,i=[];const o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i.forEach(s=>{e?s.reject(e):s.resolve(t)}),i=[]},d=e=>{const t=n.A.create({baseURL:e});return t.interceptors.request.use(e=>{const t=localStorage.getItem("accessToken");return t&&(e.headers.Authorization=`Bearer ${t}`),console.log("Request Headers (from Interceptor):",e.headers),e},e=>Promise.reject(e)),t.interceptors.response.use(e=>e,async s=>{var a;const r=s.config;if(401===(null===(a=s.response)||void 0===a?void 0:a.status)&&!r._retry){if(l)return new Promise((e,t)=>{i.push({resolve:e,reject:t})}).then(e=>(r.headers.Authorization=`Bearer ${e}`,t(r))).catch(e=>Promise.reject(e));r._retry=!0,l=!0;const s=localStorage.getItem("accessToken");console.log(`\ud83d\udd34 Token expired for ${e}. Old Token:`,s);try{const t=await n.A.post("https://hrms.anasolconsultancyservices.com/api/auth/refresh-token",{},{withCredentials:!0}),{accessToken:s}=t.data;localStorage.setItem("accessToken",s),console.log(`\ud83d\udfe2 New Token for ${e}:`,s),r.data instanceof FormData&&(r.data=function(e){const t=new FormData;for(let[s,a]of e.entries())t.append(s,a);return t}(r.data)),o(null,s);const a=d(e);return r.headers.Authorization=`Bearer ${s}`,a(r)}catch(c){return console.error("Refresh token failed. Logging out.",c),localStorage.clear(),window.location.href="/login",o(c),Promise.reject(c)}finally{l=!1}}return Promise.reject(s)}),t};window.addEventListener("storage",e=>{"accessToken"===e.key&&console.log("\ud83d\udd04 Token updated in another tab:",e.newValue)});const c=d("https://hrms.anasolconsultancyservices.com/api"),u=async function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:15;try{const r=await c.get(`/chat/${e}/${t}?page=${s}&size=${a}`);return console.log(`Response for messages page ${s}:`,r),r.data}catch(r){return console.error(`Failed to fetch messages for chat ${t}:`,r),[]}},g=async(e,t)=>{try{const s=await c.get(`/chat/${e}/attachments`,{params:{type:t}});return console.log(`Response for ${t}:`,s.data),s.data}catch(s){return console.error(`Failed to fetch ${t} for chat ${e}:`,s),[]}};var m=s(2397);const h=(e,t)=>{if(!e.lastMessage||"Chat cleared"===e.lastMessage)return"";const s=e.lastMessage,a=e.lastMessageSenderId===t?"You: ":"";if(e.lastMessageType)switch(e.lastMessageType.toUpperCase()){case"IMAGE":return a+"\ud83d\udcf7 Image";case"AUDIO":return a+"\ud83c\udfa4 Voice Message";case"FILE":return a+`\ud83d\udcce ${s}`;case"DELETED":return"This message was deleted"}return s.match(/\.(jpeg|jpg|gif|png|webp)$/i)?a+"\ud83d\udcf7 Image":s.match(/\.(mp3|wav|ogg|m4a|webm)$/i)?a+"\ud83c\udfa4 Voice Message":s.match(/\.(pdf|doc|docx|ppt|pptx|xls|xlsx|zip|rar)$/i)?a+`\ud83d\udcce ${s}`:a+s},x=(e,t)=>{if(!e||!Array.isArray(e))return{groups:[],privateChatsWith:[]};const s={groups:[],privateChatsWith:[]};return e.forEach(e=>{const a={chatId:e.chatId,name:e.groupName||e.employeeName,lastMessage:h(e,t),lastMessageTimestamp:e.lastSeen,unreadMessageCount:e.unreadMessageCount,profile:e.profile||null,isOnline:e.isOnline,memberCount:e.memberCount||0,type:"GROUP"===e.chatType?"group":"private"};"group"===a.type?s.groups.push(a):s.privateChatsWith.push(a)}),s},p=e=>{let t;try{if(e.timestamp){const s=String(e.timestamp);t=new Date(s.endsWith("Z")?s:s+"Z").toISOString()}else t=e.date&&e.time?new Date(`${e.date} ${e.time} UTC`).toISOString():(new Date).toISOString()}catch(l){t=(new Date).toISOString()}let s="text",a=e.fileUrl||null;e.fileName?s=e.fileType?e.fileType.startsWith("image/")?"image":e.fileType.startsWith("audio/")?"audio":e.fileType.startsWith("video/")?"video":"file":e.fileName.match(/\.(jpeg|jpg|gif|png|webp)$/i)?"image":e.fileName.match(/\.(mp3|wav|ogg|m4a)$/i)?"audio":e.fileName.match(/\.(mp4|webm|mov)$/i)?"video":"file":e.kind&&"text"!==e.kind&&(s=e.kind.toLowerCase());const r=e.id||e.messageId;if(!a&&["image","video","audio","file"].includes(s)&&r){a=`${m.Pt.defaults.baseURL}/chat/file/${r}`}e.isDeleted&&(s="deleted");const n=e.id||e.messageId;return{id:n,messageId:n,content:e.content,sender:e.sender,timestamp:t,status:!0===e.seen||"true"===String(e.isSeen)?"seen":"sent",type:s,isEdited:e.isEdited||!1,isPinned:e.pinned||!1,fileName:e.fileName||null,fileUrl:a,fileSize:e.fileSize||null,duration:e.duration||0,clientId:e.clientId||null,isForwarded:e.forwarded||!1,forwardedFrom:e.forwardedFrom||null,isReply:!!e.replyTo,replyTo:e.replyTo?{sender:e.replyTo.senderId,content:e.replyTo.content,originalMessageId:e.replyTo.originalMessageId,type:e.replyTo.type}:null}};var f=s(9910),y=s(1266),b=s(184),v=s(1462),j=s(4258),w=s(579);const N=e=>{if(!e||0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]},k=e=>{var t;let{fileName:s,className:a="text-3xl"}=e;const r=null===s||void 0===s||null===(t=s.split(".").pop())||void 0===t?void 0:t.toLowerCase();return["pdf"].includes(r)?(0,w.jsx)(b.kl1,{className:`text-red-500 ${a}`}):["doc","docx"].includes(r)?(0,w.jsx)(b.WLb,{className:`text-blue-700 ${a}`}):["ppt","pptx"].includes(r)?(0,w.jsx)(b.rgF,{className:`text-orange-500 ${a}`}):["xls","xlsx"].includes(r)?(0,w.jsx)(b.Ru,{className:`text-green-600 ${a}`}):["zip","rar","7z"].includes(r)?(0,w.jsx)(b.aw1,{className:`text-yellow-500 ${a}`}):["png","jpg","jpeg","gif","webp"].includes(r)?(0,w.jsx)(b.dkL,{className:`text-purple-500 ${a}`}):["mp3","wav","ogg"].includes(r)?(0,w.jsx)(b.EVA,{className:`text-pink-500 ${a}`}):(0,w.jsx)(b.t69,{className:`text-gray-500 ${a}`})},I=e=>{let{msg:t,isMyMessage:s,theme:a}=e;const r=`${c.defaults.baseURL}/chat/file/${t.messageId}`,n=(0,w.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg max-w-xs md:max-w-sm "+(s?"bg-blue-600":"dark"===a?"bg-gray-700":"bg-gray-200"),children:[(0,w.jsx)("div",{className:"flex-shrink-0 p-2 bg-white/20 rounded-lg",children:(0,w.jsx)(k,{fileName:t.fileName,className:"text-4xl"})}),(0,w.jsxs)("div",{className:"flex-grow overflow-hidden mr-2",children:[(0,w.jsx)("p",{className:"font-semibold truncate "+(s||"dark"===a?"text-white":"text-gray-800"),children:t.fileName}),(0,w.jsx)("p",{className:"text-sm "+(s?"text-blue-200":"dark"===a?"text-gray-400":"text-gray-600"),children:N(t.fileSize)})]}),(0,w.jsx)("div",{onClick:e=>{e.preventDefault(),e.stopPropagation(),window.open(r,"_blank")},className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-black/20 hover:bg-black/30 text-white transition-colors cursor-pointer",children:(0,w.jsx)(b.WCW,{size:18})})]});return s?n:(0,w.jsx)("div",{onClick:()=>window.open(r,"_blank"),className:"cursor-pointer",children:n})},S=e=>{let{src:t,fileUrl:s,isSender:r,initialDuration:n=0,fileSize:l=0,theme:i}=e;const o=(0,a.useRef)(null),[d,c]=(0,a.useState)(!1),[u,g]=(0,a.useState)(0),[m,h]=(0,a.useState)(n),[x,p]=(0,a.useState)(t||null),[f,y]=(0,a.useState)(!1);(0,a.useEffect)(()=>{const e=o.current;if(!e)return;const t=()=>{e.duration!==1/0&&e.duration>0&&h(e.duration)},s=()=>g(e.currentTime),a=()=>c(!1);return e.addEventListener("loadedmetadata",t),e.addEventListener("timeupdate",s),e.addEventListener("ended",a),()=>{e.removeEventListener("loadedmetadata",t),e.removeEventListener("timeupdate",s),e.removeEventListener("ended",a)}},[x]);const v=async()=>{if(!f){y(!0);try{const e=await fetch(s),t=await e.blob(),a=URL.createObjectURL(t);p(a)}catch(e){console.error("Failed to download audio:",e)}finally{y(!1)}}},j=e=>{if(!e||e===1/0)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`},k=m?u/m*100:0;return x?(0,w.jsxs)("div",{className:"flex items-center gap-3 p-2 w-64",children:[(0,w.jsx)("audio",{ref:o,src:x,preload:"metadata"}),(0,w.jsx)("button",{onClick:()=>{o.current&&(d?o.current.pause():o.current.play().catch(e=>console.error("Audio play failed:",e)),c(!d))},className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center "+(r?"bg-white text-blue-600":"bg-gray-400 bg-opacity-30 text-white"),children:d?(0,w.jsx)(b.kwt,{size:16}):(0,w.jsx)(b.gSK,{size:16,className:"ml-1"})}),(0,w.jsxs)("div",{className:"flex-grow flex flex-col justify-center",children:[(0,w.jsx)("div",{className:"w-full h-1.5 bg-black/20 rounded-full cursor-pointer",onClick:e=>{if(!m)return;const t=e.currentTarget.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*m;o.current&&(o.current.currentTime=s)},children:(0,w.jsx)("div",{style:{width:`${k}%`},className:"h-full rounded-full "+(r?"bg-white":"bg-gray-300")})}),(0,w.jsx)("span",{className:"text-xs self-end mt-1 "+(r?"text-blue-200":"dark"===i?"text-gray-400":"text-gray-500"),children:j(m)})]})]}):(0,w.jsxs)("div",{className:"flex items-center gap-3 p-2 w-64",children:[f?(0,w.jsx)("div",{className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-gray-400 bg-opacity-30",children:(0,w.jsx)("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"})}):(0,w.jsx)("button",{onClick:v,className:"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-gray-400 bg-opacity-30 text-white hover:bg-opacity-40 transition-colors",children:(0,w.jsx)(b.WCW,{size:16})}),(0,w.jsxs)("div",{className:"flex-grow flex flex-col justify-center",children:[(0,w.jsx)("p",{className:"text-sm "+(r||"dark"===i?"text-white":"text-gray-700"),children:"Voice Message"}),(0,w.jsxs)("div",{className:"flex justify-between items-center mt-1",children:[(0,w.jsx)("span",{className:"text-xs "+(r?"text-blue-200":"dark"===i?"text-gray-400":"text-gray-500"),children:N(l)}),(0,w.jsx)("span",{className:"text-xs "+(r?"text-blue-200":"dark"===i?"text-gray-400":"text-gray-500"),children:j(m)})]})]})]})},C=e=>{let{theme:t}=e;return(0,w.jsxs)("div",{className:"space-y-4 p-4",children:[(0,w.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,w.jsx)("div",{className:`w-8 h-8 rounded-full ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse flex-shrink-0`}),(0,w.jsx)("div",{className:`h-10 rounded-lg ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse w-48`})]}),(0,w.jsxs)("div",{className:"flex items-end gap-2 justify-end",children:[(0,w.jsx)("div",{className:`h-12 rounded-lg ${"dark"===t?"bg-blue-700":"bg-blue-200"} animate-pulse w-32`}),(0,w.jsx)("div",{className:`w-8 h-8 rounded-full ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse flex-shrink-0`})]}),(0,w.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,w.jsx)("div",{className:`w-8 h-8 rounded-full ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse flex-shrink-0`}),(0,w.jsx)("div",{className:`h-16 rounded-lg ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse w-64`})]}),(0,w.jsxs)("div",{className:"flex items-end gap-2 justify-end",children:[(0,w.jsx)("div",{className:`h-10 rounded-lg ${"dark"===t?"bg-blue-700":"bg-blue-200"} animate-pulse w-40`}),(0,w.jsx)("div",{className:`w-8 h-8 rounded-full ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse flex-shrink-0`})]}),(0,w.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,w.jsx)("div",{className:`w-8 h-8 rounded-full ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse flex-shrink-0`}),(0,w.jsx)("div",{className:`h-10 rounded-lg ${"dark"===t?"bg-gray-700":"bg-gray-200"} animate-pulse w-32`})]})]})},$=e=>{let{chat:t,onClose:s,theme:r}=e;const[n,l]=(0,a.useState)(!1);return n&&"private"===t.type?(0,w.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-[120]",onClick:()=>l(!1),children:(0,w.jsx)("img",{src:null===t||void 0===t?void 0:t.profile,alt:null===t||void 0===t?void 0:t.name,className:"max-w-[90vw] max-h-[90vh] object-contain"})}):(0,w.jsx)("div",{className:"fixed inset-0 bg-black/30 backdrop-blur-sm flex justify-center items-center z-[110] md:hidden",onClick:s,children:(0,w.jsxs)("div",{className:"relative w-11/12 max-w-xs cursor-pointer",onClick:e=>{e.stopPropagation(),"private"===t.type&&l(!0)},children:["group"===t.type?(0,w.jsx)("div",{className:"w-full aspect-square bg-gray-700 rounded-lg shadow-lg flex items-center justify-center",children:(0,w.jsx)(b.YXz,{className:"text-gray-400",size:120})}):(0,w.jsx)("img",{src:null===t||void 0===t?void 0:t.profile,alt:null===t||void 0===t?void 0:t.name,className:"w-full aspect-square object-cover rounded-lg shadow-lg"}),(0,w.jsx)("div",{className:"absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent rounded-b-lg",children:(0,w.jsx)("h3",{className:"text-xl font-bold text-white text-center truncate",children:null===t||void 0===t?void 0:t.name})})]})})};const T=function(e){let{currentUser:t,chats:s,loadMoreChats:n,hasMore:l,isFetchingMore:i,theme:o}=e;const d=(0,r.zy)(),m=(0,r.Zp)(),[N,T]=(0,a.useState)({groups:[],privateChatsWith:[]}),[M,E]=(0,a.useState)(""),[R,D]=(0,a.useState)(null),[F,z]=(0,a.useState)(""),[L,W]=(0,a.useState)({}),[U,A]=(0,a.useState)(!1),[O,P]=(0,a.useState)(!1),[V,q]=(0,a.useState)(!1),[B,H]=(0,a.useState)(!1),[Y,Z]=(0,a.useState)(!1),[_,X]=(0,a.useState)({}),[J,Q]=(0,a.useState)({visible:!1,x:0,y:0,message:null,index:null}),[G,K]=(0,a.useState)({index:null,originalContent:""}),[ee,te]=(0,a.useState)(null),[se,ae]=(0,a.useState)(null),[re,ne]=(0,a.useState)(null),[le,ie]=(0,a.useState)({visible:!1,message:null}),[oe,de]=(0,a.useState)([]),[ce,ue]=(0,a.useState)(""),[ge,me]=(0,a.useState)(!1),[he,xe]=(0,a.useState)(!1),[pe,fe]=(0,a.useState)(!1),[ye,be]=(0,a.useState)("Overview"),[ve,je]=(0,a.useState)([]),[we,Ne]=(0,a.useState)(!1),[ke,Ie]=(0,a.useState)(null),[Se,Ce]=(0,a.useState)(!1),[$e,Te]=(0,a.useState)(!1),[Me,Ee]=(0,a.useState)(!1),[Re,De]=(0,a.useState)({}),[Fe,ze]=(0,a.useState)({}),[Le,We]=(0,a.useState)({}),[Ue,Ae]=(0,a.useState)(!1),[Oe,Pe]=(0,a.useState)(!1),[Ve,qe]=(0,a.useState)(0),[Be,He]=(0,a.useState)(null),[Ye,Ze]=(0,a.useState)(null),[_e,Xe]=(0,a.useState)(!1),[Je,Qe]=(0,a.useState)([]),[Ge,Ke]=(0,a.useState)([]),[et,tt]=(0,a.useState)([]),[st,at]=(0,a.useState)(!1),[rt,nt]=(0,a.useState)(!1),[lt,it]=(0,a.useState)(""),[ot,dt]=(0,a.useState)([]),[ct,ut]=(0,a.useState)(-1),{setIsChatWindowVisible:gt}=(0,a.useContext)(f.o);(0,a.useEffect)(()=>{gt&&gt(O)},[O,gt]);const mt=(0,a.useRef)(null),ht=(0,a.useRef)(null),xt=(0,a.useRef)(null),pt=(0,a.useRef)({}),ft=(0,a.useRef)(null),yt=(0,a.useRef)(null),bt=(0,a.useRef)([]),vt=(0,a.useRef)(null),jt=(0,a.useRef)(null),wt=(0,a.useRef)(null),Nt=(0,a.useRef)(null),kt=(0,a.useRef)(null),It=(0,a.useRef)(null),St=(0,a.useRef)(null),Ct=(0,a.useRef)(!1),$t=(0,a.useRef)(null),Tt=(0,a.useRef)(null),Mt=(0,a.useRef)(null),Et=(0,a.useRef)(!1),Rt=(0,a.useRef)({}),Dt=(0,a.useMemo)(()=>{if("undefined"!==typeof window&&window.location.pathname.includes("/with")){return new URLSearchParams(window.location.search).get("id")}return null},[]);(0,a.useEffect)(()=>{if(""===lt.trim())return dt([]),void ut(-1);const e=setTimeout(()=>{R&&(async(e,t,s)=>{try{return(await c.get("/chat/search",{params:{userId:e,chatId:t,query:s}})).data}catch(a){return console.error(`Failed to search messages in chat ${t}:`,a),[]}})(t.id,R.chatId,lt).then(e=>{dt(e),ut(e.length>0?0:-1)})},500);return()=>clearTimeout(e)},[lt,R,t.id]),(0,a.useEffect)(()=>{if(-1!==ct&&ot[ct]){const e=ot[ct].messageId,t=document.getElementById(`msg-${e}`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})}},[ct,ot]);const Ft=async e=>{nt(!1),it(""),dt([]);const s=await(async(e,t,s)=>{try{return(await c.get("/chat/context",{params:{messageId:e,userId:t,chatId:s}})).data}catch(a){return console.error(`Failed to fetch message context for message ${e}:`,a),[]}})(e.messageId,t.id,R.chatId);if(s&&s.length>0){const t=s.map(p);W(e=>({...e,[R.chatId]:t})),setTimeout(()=>{const t=document.getElementById(`msg-${e.messageId}`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("bg-blue-200","transition-all","duration-1000"),setTimeout(()=>{t.classList.remove("bg-blue-200")},2e3))},100)}},zt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth";ht.current&&ht.current.scrollTo({top:ht.current.scrollHeight,behavior:e}),qe(0)};(0,a.useEffect)(()=>{if(""===M.trim())return Ze(null),void Xe(!1);Xe(!0);const e=setTimeout(()=>{(async(e,t)=>{try{return(await c.get("/chat/overview/search",{params:{employeeId:e,query:t}})).data}catch(s){return console.error("Failed to search chat overview:",s),[]}})(t.id,M).then(e=>{const s=x(e,t.id),a=[...s.privateChatsWith,...s.groups].sort((e,t)=>new Date(t.lastMessageTimestamp)-new Date(e.lastMessageTimestamp));Ze(a)}).finally(()=>Xe(!1))},300);return()=>clearTimeout(e)},[M,t.id]),(0,a.useEffect)(()=>{if(s){const e={groups:s.groups.map(e=>e.chatId.toString()===Dt?{...e,unreadMessageCount:0}:e),privateChatsWith:s.privateChatsWith.map(e=>e.chatId.toString()===Dt?{...e,unreadMessageCount:0}:e)};T(e),Ce(!0)}},[s,Dt]);const Lt=(0,a.useCallback)(async(e,s)=>{if(!(s>0&&Ue||0===s&&U)){s>0?(Ae(!0),Et.current=!0):A(!0);try{const a=await u(t.id,e,s,15);if(console.log("%c REFRESH (API) RAW DATA:","color: red; font-weight: bold;",a),0===a.length)return void We(t=>({...t,[e]:!1}));const r=a.map(p),n=ht.current,l=n?n.scrollHeight:0,i=n?n.scrollTop:0;W(t=>({...t,[e]:0===s?r:[...r,...t[e]||[]]})),s>0&&requestAnimationFrame(()=>{n&&(n.scrollTop=n.scrollHeight-l+i)}),0===a.length&&We(t=>({...t,[e]:!1}))}catch(a){console.error(`Failed to load messages for chat ${e}:`,a)}finally{s>0?(Ae(!1),setTimeout(()=>{Et.current=!1},100)):A(!1)}}},[t.id,Ue,U,u]);(0,a.useEffect)(()=>{if(!R)return;const e=R.chatId;ze(t=>({...t,[e]:0})),We(t=>({...t,[e]:!0})),W(t=>({...t,[e]:[]})),Lt(e,0);(async()=>{try{const s=await(async(e,t,s)=>{try{const a=await c.get(`/chat/${e}/pinned?chatType=${t}&userId=${s}`);return console.log("Response:",a),a.data}catch(a){return console.error(`Failed to fetch pinned message for chat ${e}:`,a),null}})(e,R.type,t.id);ne(s)}catch(s){console.error("Failed to fetch pinned message:",s),ne(null)}})()},[R,t.id]);const Wt=(0,a.useCallback)((e,s)=>{T(a=>{const r=a=>{if(a.chatId===e){const r=s&&"deleted"!==s.type&&!s.isDeleted&&s.sender!==t.id&&(null===R||void 0===R?void 0:R.chatId)!==e,n={lastMessage:s?s.fileName||s.content:"",lastMessageType:s?s.type.toUpperCase():null,lastMessageSenderId:s?s.sender:null};return{...a,lastMessage:s?h(n,t.id):"Chat cleared",lastMessageTimestamp:(null===s||void 0===s?void 0:s.timestamp)||new Date(0).toISOString(),unreadMessageCount:(a.unreadMessageCount||0)+(r?1:0)}}return a};return{groups:a.groups.map(r),privateChatsWith:a.privateChatsWith.map(r)}})},[t.id,R]),Ut=(0,a.useCallback)(e=>{const s=ht.current,a=!s||s.scrollHeight-s.scrollTop-s.clientHeight<300,r=JSON.parse(e.body);if(console.log("%c LIVE MSG (WebSocket) RAW DATA:","color: green; font-weight: bold;",r),console.log("Received WebSocket Message:",r),"STATUS_UPDATE"===r.type){const{status:e,chatId:t,messageIds:s}=r;return void W(a=>{const n="group"===(null===R||void 0===R?void 0:R.type)?r.groupId:t,l=a[n]||[],i=e.toLowerCase(),o=l.map(e=>{if(s.includes(e.messageId)){if("seen"===i)return{...e,status:"seen"};if("delivered"===i&&"sent"===e.status)return{...e,status:"delivered"}}return e});return{...a,[n]:o}})}if("PIN_UPDATE"===r.type){const e=r.payload,s=e.groupId||(e.sender===t.id?e.receiver:e.sender);return void((null===R||void 0===R?void 0:R.chatId)===s&&ne(e))}if("UNPIN_UPDATE"===r.type){const e=r.payload;let s;return s="group"===R.type?e.groupId:e.senderId===t.id?e.receiverId:e.senderId,void((null===R||void 0===R?void 0:R.chatId)===s&&ne(null))}const n=r,l=n.groupId||(n.sender===t.id?n.receiver:n.sender);if(!l)return void console.warn("Received message without a clear chat ID",n);if(n.isDeleted||"deleted"===n.type)return void W(e=>{const t=e[l]||[];let s=!1;if(t.length>0){const e=t[t.length-1];s=e.messageId===n.messageId||e.id===n.messageId}const a=t.map(e=>e.messageId===n.messageId||e.id===n.messageId?{...e,type:"deleted",content:"This message was deleted",fileName:null,fileSize:null,isDeleted:!0}:e);if(s){const e=a.length>0?a[a.length-1]:null;Wt(l,e)}return{...e,[l]:a}});if(n.isEdited)return void W(e=>{const t=e[l]||[],s=t.map(e=>{if(e.messageId===n.id||e.messageId===n.messageId){const s={...e,content:n.content,isEdited:!0};return t.length>0&&t[t.length-1].messageId===e.messageId&&Wt(l,s),s}return e});return{...e,[l]:s}});p(n);W(e=>{const s=e[l]||[],a=n.messageId||n.id;if(s.some(e=>e.messageId===a&&"sent"===e.status))return e;let r=[...s],i=!1,o=null;const d=n.sender===t.id&&n.client_id,c=n.sender===t.id&&!n.client_id,u=n.sender!==t.id;if(d){const e=r.findIndex(e=>e.id===n.client_id);if(e>-1){const t=p(n);r[e]={...r[e],...t,status:"sent"},o=r[e],i=!0}}else if(c){const e=r.findLastIndex(e=>"sending"===e.status&&e.sender===t.id);if(e>-1){const t=p(n);r[e]={...r[e],...t,status:"sent"},o=r[e],i=!0}else if(!s.some(e=>e.messageId===a)){const e=p(n);r.push(e),o=e,i=!0}}else if(u&&!s.some(e=>e.messageId===a)){const e=p(n);r.push(e),o=e,i=!0,Oe&&qe(e=>e+1)}return i?(Wt(l,o),{...e,[l]:r}):e});r.sender!==t.id&&!r.isEdited&&!r.isDeleted&&"deleted"!==r.type&&a&&setTimeout(()=>zt("smooth"),100)},[t.id,Wt,R,Oe]),At=(0,a.useMemo)(()=>[...N.privateChatsWith.filter(e=>e.chatId!==(null===t||void 0===t?void 0:t.id)),...N.groups].sort((e,t)=>new Date(t.lastMessageTimestamp)-new Date(e.lastMessageTimestamp)),[N,t.id]),Ot=(0,a.useCallback)(e=>{const s=JSON.parse(e.body);if(s.senderId===t.id)return;const a="TEAM"===s.type?s.groupId:s.senderId;if(!a)return;const r=At.find(e=>e.chatId===s.senderId),n=(null===r||void 0===r?void 0:r.name)||"Someone";De(e=>{const t={...e};return pt.current[a]&&clearTimeout(pt.current[a]),s.typing?(t[a]=`${n} is typing...`,pt.current[a]=setTimeout(()=>{De(e=>{const t={...e};return delete t[a],t})},3e3)):delete t[a],t})},[t.id,At]);(0,a.useEffect)(()=>{Mt.current=Ut}),(0,a.useEffect)(()=>{!U&&ht.current&&zt("auto")},[U,R]),(0,a.useEffect)(()=>{if(null===t||void 0===t||!t.id||!Se)return;if(xt.current)return;const e=`wss://hrms.anasolconsultancyservices.com/api/chat?employeeId=${t.id}`,s=new y.K({brokerURL:e,reconnectDelay:5e3,onConnect:()=>{Te(!0);const e=e=>{Mt.current&&Mt.current(e)};Rt.current.private=s.subscribe("/user/queue/private",e),Rt.current["private-ack"]=s.subscribe("/user/queue/private-ack",e),Rt.current["group-ack"]=s.subscribe("/user/queue/group-ack",e),Rt.current.presence=s.subscribe("/topic/presence",e=>{const s=JSON.parse(e.body);s.userId!==t.id&&T(e=>{const t=e.privateChatsWith.map(e=>e.chatId===s.userId?{...e,isOnline:s.isOnline}:e);return{...e,privateChatsWith:t}})}),Rt.current.typing=s.subscribe("/user/queue/typing-status",Ot)},onWebSocketError:e=>console.error("WebSocket Error:",e),onStompError:e=>console.error("STOMP Error:",e.headers.message,e.body),onWebSocketClose:()=>{Te(!1)}});return s.activate(),xt.current=s,()=>{var e;null!==(e=xt.current)&&void 0!==e&&e.active&&(xt.current.deactivate(),xt.current=null)}},[null===t||void 0===t?void 0:t.id,Se]);const Pt=(0,a.useMemo)(()=>(N.groups||[]).map(e=>e.chatId).sort().join(","),[N.groups]);(0,a.useEffect)(()=>{var e;if(!$e||null===(e=xt.current)||void 0===e||!e.active)return;const t=e=>{Mt.current&&Mt.current(e)},s=new Set((N.groups||[]).map(e=>e.chatId.toString())),a=Object.keys(Rt.current),r=new Set(a.filter(e=>e.startsWith("group-")).map(e=>e.replace("group-","")));r.forEach(e=>{if(!s.has(e)){const t=`group-${e}`;Rt.current[t]&&(Rt.current[t].unsubscribe(),delete Rt.current[t])}}),s.forEach(e=>{if(!r.has(e)){const s=`group-${e}`;Rt.current[s]=xt.current.subscribe(`/topic/team-${e}`,t);const a=`group-typing-${e}`;Rt.current[a]=xt.current.subscribe(`/topic/typing-status/${e}`,Ot)}})},[$e,Pt,N.groups,ve,t.id]);const Vt=(0,a.useCallback)(e=>{var s;if(null===t||void 0===t||!t.id||null===(s=xt.current)||void 0===s||!s.active)return;const a=`/app/presence/open/${e.chatId}`,r={userId:t.id,type:"group"===e.type?"TEAM":"PRIVATE"};xt.current.publish({destination:a,body:JSON.stringify(r)}),D(e),P(!0);const n=`/chat/${t.id}/with?id=${e.chatId}`;window.history.pushState({path:n},"",n)},[t.id]),qt=(0,a.useCallback)(()=>{var e;if(Ct.current=!0,!R||null===t||void 0===t||!t.id)return void(Ct.current=!1);if(null!==(e=xt.current)&&void 0!==e&&e.active){const e=`/app/presence/close/${R.chatId}`;xt.current.publish({destination:e,body:"{}"})}D(null),P(!1);const s=`/chat/${t.id}`;m(s)},[R,t.id,m]),Bt=(0,a.useCallback)(e=>{T(t=>{const s="group"===e.type,a=s?t.groups:t.privateChatsWith;if(a.some(t=>t.chatId===e.chatId)){const r=a.map(t=>t.chatId===e.chatId?{...t,unreadMessageCount:0}:t);return s?{...t,groups:r}:{...t,privateChatsWith:r}}{const a={...e,unreadMessageCount:0};return s?{...t,groups:[a,...t.groups]}:{...t,privateChatsWith:[a,...t.privateChatsWith]}}}),Vt(e),E("")},[Vt]);(0,a.useEffect)(()=>{const e=()=>{if(R&&xt.current&&xt.current.active){const e=`/app/presence/close/${R.chatId}`;xt.current.publish({destination:e,body:"{}"})}};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[R]),(0,a.useEffect)(()=>{(async()=>{if(pe&&R&&"group"===R.type){Ne(!0),at(!0);try{if("Members"===ye&&0===ve.length){const e=await(async e=>{try{const t=await c.get(`/chat/team/employee/${e}`);return console.log("Response:",t),t.data}catch(t){return console.error(`Failed to fetch members for team ${e}:`,t),null}})(R.chatId),t=Array.isArray(e)&&e.length>0?e[0]:null;je((null===t||void 0===t?void 0:t.employees)||[])}else if("Media"===ye&&0===Je.length){const e=await g(R.chatId,"media");Qe(e.map(p))}else if("Files"===ye&&0===Ge.length){const e=await g(R.chatId,"files");Ke(e.map(p))}else if("Links"===ye&&0===et.length){const e=await g(R.chatId,"links");tt(e)}}catch(e){console.error("Failed to fetch group data for tab:",ye,e)}finally{Ne(!1),at(!1)}}})()},[pe,ye,R]),(0,a.useEffect)(()=>{const e=e=>{var t,s,a;!V||!jt.current||jt.current.contains(e.target)||null!==(t=wt.current)&&void 0!==t&&t.contains(e.target)||q(!1),!Y||!Nt.current||Nt.current.contains(e.target)||null!==(s=kt.current)&&void 0!==s&&s.contains(e.target)||Z(!1),J.visible&&It.current&&!It.current.contains(e.target)&&Q({visible:!1,x:0,y:0,message:null,index:null}),!ge||!$t.current||$t.current.contains(e.target)||null!==(a=Tt.current)&&void 0!==a&&a.contains(e.target)||me(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[V,Y,J.visible,ge]);const Ht=e=>{var s;if(null===(s=xt.current)||void 0===s||!s.active||!R)return;const a={senderId:t.id,typing:e,type:"group"===R.type?"TEAM":"PRIVATE",receiverId:"private"===R.type?R.chatId:null,groupId:"group"===R.type?R.chatId:null};xt.current.publish({destination:"/app/typing",body:JSON.stringify(a)})},Yt=()=>{if(!F.trim()||!R)return;Ht(!1);const e=Date.now().toString()+Math.random().toString(36).substring(2,9),s=null!==ee,a={id:e,messageId:e,sender:t.id,content:F,timestamp:(new Date).toISOString(),status:"sending",type:"text",fileName:null,fileSize:null,isEdited:!1,replyTo:ee,isForwarded:!1};let r,n;Wt(R.chatId,a),W(e=>({...e,[R.chatId]:[...e[R.chatId]||[],a]})),s?(r="/app/reply",n={replyToMessageId:ee.messageId,sender:t.id,content:F,clientId:e,receiver:"private"===R.type?R.chatId:null,groupId:"group"===R.type?R.chatId:null,type:"group"===R.type?"TEAM":"PRIVATE"}):(r="/app/send",n={sender:t.id,content:F,type:"group"===R.type?"TEAM":"PRIVATE",receiver:"private"===R.type?R.chatId:null,groupId:"group"===R.type?R.chatId:null,clientId:e}),xt.current.publish({destination:r,body:JSON.stringify(n)}),z(""),q(!1),te(null),setTimeout(()=>zt("smooth"),100)},Zt=()=>{navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{console.log("Permission granted, starting MediaRecorder..."),H(!0),vt.current=e,bt.current=[];const s=new MediaRecorder(e);yt.current=s,s.ondataavailable=e=>{bt.current.push(e.data)},s.onstop=async()=>{console.log("Recording stopped, creating blob from chunks...");const e=new Blob(bt.current,{type:"audio/webm"});if(!R)return;const s=new File([e],`voice-message-${Date.now()}.webm`,{type:"audio/webm",lastModified:Date.now()}),a=new FileReader;a.readAsDataURL(s),a.onloadend=async()=>{const e=a.result.split(",")[1],r=Date.now().toString()+Math.random().toString(36).substring(2,9),n=URL.createObjectURL(s),l={id:r,messageId:r,sender:t.id,content:n,timestamp:(new Date).toISOString(),status:"sending",type:"audio",fileName:s.name,fileSize:s.size,fileUrl:n,isEdited:!1,duration:0};Wt(R.chatId,l),W(e=>({...e,[R.chatId]:[...e[R.chatId]||[],l]}));const i={sender:t.id,clientId:r,fileType:s.type,fileName:s.name,fileData:e,type:"group"===R.type?"TEAM":"PRIVATE",groupId:"group"===R.type?R.chatId:null,receiver:"private"===R.type?R.chatId:null,duration:0};try{await(async e=>{try{const t=await c.post("/chat/voice/upload",e);return console.log("Response:",t),t.data}catch(t){throw console.error("Voice message upload failed:",t),t}})(i)}catch(o){console.error("Voice message upload failed:",o),W(e=>{const t=(e[R.chatId]||[]).map(e=>e.id===r?{...e,status:"failed"}:e);return{...e,[R.chatId]:t}})}}},s.start()}).catch(e=>{console.error("Microphone permission denied:",e),H(!1),alert("Microphone permission is required for voice messages.")})},_t=()=>{console.log("Stopping MediaRecorder..."),yt.current&&"recording"===yt.current.state&&yt.current.stop(),vt.current&&vt.current.getTracks().forEach(e=>e.stop()),H(!1)},Xt=()=>{var e;const s=F.trim();if(""===s||null===G.index||null===(e=xt.current)||void 0===e||!e.active)return void Jt();const a=R.chatId,r=L[a],n=r[G.index],l=n.messageId;if(s===G.originalContent||"number"!==typeof l)return void Jt();const i={...n,content:s,isEdited:!0},o=r.map((e,t)=>t===G.index?i:e);W(e=>({...e,[a]:o})),G.index===r.length-1&&Wt(a,i);const d={messageId:l,content:s,sender:t.id};xt.current.publish({destination:"/app/edit",body:JSON.stringify(d)}),Jt()},Jt=()=>{K({index:null,originalContent:""}),z("")},Qt=async e=>{const s=R.chatId,a=[...L[s]||[]],r=a[J.index],n=null===r||void 0===r?void 0:r.messageId;if(!n||"number"!==typeof n||"sending"===r.status||"failed"===r.status)return console.error("Invalid messageId or message status for deletion:",n,r.status),void Q({visible:!1,x:0,y:0,message:null,index:null});try{if(e)await(async(e,t)=>{try{const s=await c.post(`/chat/${e}/everyone?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to delete message ${e} for everyone:`,s),s}})(n,t.id);else{await(async(e,t)=>{try{const s=await c.post(`/chat/${e}/me?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to delete message ${e} for me:`,s),s}})(n,t.id);const e=a.filter((e,t)=>t!==J.index);W(t=>({...t,[s]:e}));const r=e.length>0?e[e.length-1]:null;Wt(s,r)}}catch(l){console.error(`Failed to delete message ${n} in component:`,l)}finally{Q({visible:!1,x:0,y:0,message:null,index:null})}},Gt=()=>{if(!se)return;const e=[...L[R.chatId]];e[se.index]=se.message,W(t=>({...t,[R.chatId]:e})),ae(null)},Kt=()=>{if(me(!1),re){const e=ls.findIndex(e=>e.messageId===re.messageId);if(-1!==e){const t=document.querySelector(`[data-message-index='${e}']`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("animate-pulse","bg-blue-200"),setTimeout(()=>t.classList.remove("animate-pulse","bg-blue-200"),2500))}}},es=null!==Ye?Ye:At;(0,a.useEffect)(()=>{if(Ct.current)Ct.current=!1;else if(Dt&&At.length>0&&$e&&!R){const e=At.find(e=>e.chatId.toString()===Dt);e&&Bt(e)}},[At,Dt,R,Bt,$e]),(0,a.useEffect)(()=>{var e;const t=null===(e=d.state)||void 0===e?void 0:e.newChatTarget;if(t&&Se){At.some(e=>e.chatId===t.chatId)||(console.log("New chat detected. Adding to chat list:",t),T(e=>{const s=[t,...e.privateChatsWith];return{...e,privateChatsWith:s}}))}},[Se,At,d.state]);const ts=e=>{if(!e)return"";const t=new Date(e.endsWith("Z")?e:e+"Z");return isNaN(t)?"":t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0})},ss=e=>{if(!e)return"";const t=new Date(String(e).endsWith("Z")?e:e+"Z");if(isNaN(t))return"Invalid Date";const s=new Date,a=new Date(s);return a.setDate(a.getDate()-1),t.toDateString()===s.toDateString()?"Today":t.toDateString()===a.toDateString()?"Yesterday":t.toLocaleDateString([],{year:"numeric",month:"long",day:"numeric"})},as=e=>{switch(e){case"sending":return"ring-yellow-400";case"sent":return"ring-gray-400";case"delivered":return"ring-blue-500";case"seen":return"ring-green-500";case"failed":return"ring-red-500";default:return"ring-transparent"}};let rs=null;const ns=R?At.find(e=>e.chatId===R.chatId):null,ls=ns&&L[ns.chatId]||[],is=e=>{if(!t)return{name:"Unknown",profile:null};if(e===t.id)return{name:"You",profile:t.profile};const s=[...N.privateChatsWith,...(null===ns||void 0===ns?void 0:ns.members)||[]].find(t=>t.chatId===e||t.employeeId===e);return s?{name:s.name||s.employeeName,profile:s.profile||null}:{name:"Unknown User",profile:null}},os=e=>{const t=c.defaults.baseURL;if(e.fileUrl&&e.fileUrl.startsWith("blob:"))return e.fileUrl;if(e.fileUrl&&e.fileUrl.startsWith("/api")){return`${new URL(t).origin}${e.fileUrl}`}if(e.fileUrl)return e.fileUrl;const s=e.id||e.messageId;return s?`${t}/chat/file/${s}`:e.content};return(0,w.jsxs)("div",{className:`w-full h-full ${"dark"===o?"bg-gray-900":"bg-gray-100"} font-sans`,children:[(0,w.jsxs)("div",{className:"flex w-full h-full p-0 md:p-4 md:gap-4",children:[(0,w.jsxs)("div",{className:`relative w-full md:w-[30%] h-full p-4 flex flex-col shadow-xl md:rounded-lg ${O?"hidden md:flex":"flex"} ${"dark"===o?"bg-gray-800":"bg-white"}`,children:[(0,w.jsx)("div",{className:"mb-4 flex-shrink-0",children:(0,w.jsx)("input",{type:"text",placeholder:"Search chats users...",className:"w-full p-3 rounded-lg border bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 "+("dark"===o?"bg-gray-700 text-white border-gray-600":"bg-gray-50 border-gray-300"),value:M,onChange:e=>E(e.target.value)})}),(0,w.jsxs)("div",{ref:mt,onScroll:()=>{const e=mt.current;if(e){const{scrollTop:t,scrollHeight:s,clientHeight:a}=e;s-t-a<100&&(console.log(`Scroll condition met. isFetchingMore: ${i}, hasMore: ${l}`),l&&!i&&n())}},className:"flex-grow space-y-2 pr-2 overflow-y-auto custom-scrollbar",children:[_e?(0,w.jsx)("div",{className:"text-center p-4 text-gray-500",children:"Searching..."}):es.map(e=>(0,w.jsxs)("div",{onClick:()=>Bt(e),className:"p-3 flex items-center rounded-lg cursor-pointer group "+((null===R||void 0===R?void 0:R.chatId)===e.chatId?"bg-blue-100 dark:bg-blue-900/30":"dark"===o?"hover:bg-gray-700":"hover:bg-blue-50"),children:[(0,w.jsxs)("div",{className:"relative flex-shrink-0",children:["group"===e.type?(0,w.jsx)("div",{onClick:t=>{t.stopPropagation(),He(e)},className:"w-11 h-11 rounded-full flex items-center justify-center cursor-pointer md:cursor-default "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.YXz,{className:"text-gray-500",size:24})}):e.profile?(0,w.jsx)("div",{onClick:t=>{t.stopPropagation(),He(e)},className:"w-11 h-11 rounded-full cursor-pointer md:cursor-default",children:(0,w.jsx)("img",{src:e.profile,alt:e.name,className:"w-full h-full rounded-full object-cover"})}):(0,w.jsx)("div",{className:"w-11 h-11 rounded-full flex items-center justify-center "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.x$1,{className:"text-gray-500",size:24})}),e.isOnline&&(0,w.jsx)("span",{className:"absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-green-500"})]}),(0,w.jsxs)("div",{className:"flex-1 min-w-0 mx-3",children:[(0,w.jsx)("p",{className:"font-semibold truncate "+("dark"===o?"text-white":"text-gray-800"),children:e.name}),(0,w.jsx)("p",{className:"text-sm truncate "+("dark"===o?"text-gray-400":"text-gray-500"),children:e.lastMessage||"No messages yet"})]}),(e.unreadMessageCount||0)>0&&(0,w.jsx)("div",{className:"flex-shrink-0",children:(0,w.jsx)("span",{className:"bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full",children:e.unreadMessageCount})})]},e.chatId)),""===M&&i&&(0,w.jsx)("div",{className:"flex justify-center items-center p-4",children:(0,w.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})})]})]}),(0,w.jsx)("div",{className:`w-full md:w-[70%] h-full flex flex-col shadow-xl md:rounded-lg relative ${O?"flex":"hidden md:flex"} ${"dark"===o?"bg-gray-800":"bg-white"}`,children:ns?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b "+("dark"===o?"border-gray-700":"border-gray-200"),children:[(0,w.jsxs)("div",{className:"flex items-center space-x-3 flex-grow min-w-0",children:[(0,w.jsx)("button",{onClick:qt,className:"md:hidden p-2 rounded-full "+("dark"===o?"hover:bg-gray-700 text-white":"hover:bg-gray-100"),children:(0,w.jsx)(b.QVr,{})}),(0,w.jsx)("button",{onClick:()=>"group"!==ns.type&&ns.profile&&xe(!0),className:"flex-shrink-0",children:"group"===ns.type?(0,w.jsx)("div",{className:"w-12 h-12 rounded-full flex items-center justify-center "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.YXz,{className:"text-gray-500",size:28})}):ns.profile?(0,w.jsx)("img",{src:ns.profile,alt:ns.name,className:"w-12 h-12 rounded-full object-cover"}):(0,w.jsx)("div",{className:"w-12 h-12 rounded-full flex items-center justify-center "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.x$1,{className:"text-gray-500",size:28})})}),(0,w.jsxs)("div",{className:"truncate",children:[(0,w.jsx)("button",{onClick:()=>{"private"===ns.type?m(`/employees/${t.id}/public/${ns.chatId}`):"group"===(null===R||void 0===R?void 0:R.type)&&(be("Overview"),je([]),fe(!0))},disabled:!ns,className:"text-left",children:(0,w.jsx)("p",{className:"font-bold text-lg truncate "+("dark"===o?"text-white":"text-gray-800"),children:ns.name})}),"private"===ns.type?(0,w.jsx)("p",{className:"text-sm "+("dark"===o?"text-gray-400":"text-gray-500"),children:ns.isOnline?"Online":(e=>{if(!e)return"Offline";const t=new Date(String(e).endsWith("Z")?e:e+"Z");if(isNaN(t))return"Offline";const s=new Date;return t.toDateString()===s.toDateString()?`last seen today at ${ts(e)}`:`last seen on ${t.toLocaleDateString()}`})(ns.lastMessageTimestamp)}):(0,w.jsxs)("p",{className:"text-sm "+("dark"===o?"text-gray-400":"text-gray-500"),children:[ns.memberCount||0," members"]})]})]}),(0,w.jsx)("div",{className:"flex items-center space-x-2",children:(0,w.jsxs)("div",{className:"relative",children:[(0,w.jsx)("button",{ref:kt,onClick:()=>Z(!Y),className:"p-2 rounded-full hover:bg-gray-100 "+("dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-600"),children:(0,w.jsx)(v.mqA,{size:20})}),Y&&(0,w.jsxs)("div",{ref:Nt,className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20",children:[(0,w.jsx)("button",{onClick:()=>{nt(!0),Z(!1)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",children:"Search"}),(0,w.jsx)("button",{onClick:()=>{Ee(!0),Z(!1)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",children:"Clear chat"})]})]})})]}),rt&&(0,w.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b "+("dark"===o?"border-gray-700":"border-gray-200"),children:[(0,w.jsx)("input",{type:"text",placeholder:"Search messages...",className:"w-full p-2 border rounded-lg "+("dark"===o?"bg-gray-700 text-white":""),value:lt,onChange:e=>{it(e.target.value)},autoFocus:!0}),ot.length>0&&(0,w.jsxs)("span",{className:"mx-2 text-sm",children:[ct+1," of ",ot.length]}),(0,w.jsxs)("div",{className:"flex",children:[(0,w.jsx)("button",{onClick:()=>{ct>0&&ut(e=>e-1)},disabled:ct<=0,className:"p-2 disabled:opacity-50",children:(0,w.jsx)(b.Ucs,{})}),(0,w.jsx)("button",{onClick:()=>{ct<ot.length-1&&ut(e=>e+1)},disabled:ct>=ot.length-1,className:"p-2 disabled:opacity-50",children:(0,w.jsx)(b.Vr3,{})}),(0,w.jsx)("button",{onClick:()=>{nt(!1),it(""),dt([])},className:"p-2",children:(0,w.jsx)(b.QCr,{})})]})]}),re&&(0,w.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-2 border-b bg-gray-50 "+("dark"===o?"bg-gray-700 border-gray-700":"border-gray-200"),children:[(0,w.jsxs)("div",{className:"flex items-center gap-2 text-sm overflow-hidden cursor-pointer flex-grow min-w-0",onClick:Kt,children:[(0,w.jsx)(b.LBY,{className:"flex-shrink-0 "+("dark"===o?"text-gray-400":"text-gray-500")}),(0,w.jsx)(k,{fileName:re.fileName||"",type:re.messageType,className:"text-lg flex-shrink-0"}),(0,w.jsxs)("div",{className:"truncate",children:[(0,w.jsx)("p",{className:"font-bold text-blue-600",children:"Pinned Message"}),(0,w.jsx)("p",{className:"truncate "+("dark"===o?"text-gray-300":"text-gray-600"),children:"text"===re.messageType?re.content:re.fileName||"Pinned Media"})]})]}),(0,w.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,w.jsx)("button",{ref:Tt,onClick:()=>me(!ge),className:"p-2 rounded-full "+("dark"===o?"hover:bg-gray-600 text-gray-300":"hover:bg-gray-200"),children:(0,w.jsx)(b.Vr3,{})}),ge&&(0,w.jsx)("div",{ref:$t,className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg z-20 text-sm "+("dark"===o?"bg-gray-700 text-white":"bg-white"),children:(0,w.jsxs)("ul",{className:"py-1",children:[(0,w.jsxs)("li",{onClick:Kt,className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 "+("dark"===o?"text-gray-300 hover:bg-gray-600":"text-gray-700"),children:[(0,w.jsx)(b.eaw,{})," Go to message"]}),(0,w.jsxs)("li",{onClick:async()=>{if(null!==re&&void 0!==re&&re.messageId)try{await(async(e,t)=>{try{const s=await c.post(`/chat/unpin/${e}?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to unpin message ${e}:`,s),s}})(re.messageId,t.id),ne(null)}catch(e){console.error("Failed to unpin message:",e)}finally{me(!1)}},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600 "+("dark"===o?"text-red-400 hover:bg-gray-600":""),children:[(0,w.jsx)(b.QCr,{})," Unpin"]})]})})]})]}),(0,w.jsx)("div",{ref:ht,onScroll:()=>{const e=ht.current;if(!e)return;const{scrollTop:t,scrollHeight:s,clientHeight:a}=e;if(0===t&&!U&&!Ue){const e=R.chatId;if(!1!==Le[e]){const t=(Fe[e]||0)+1;ze(s=>({...s,[e]:t})),Lt(e,t)}}const r=s-t-a>400;r!==Oe&&(Pe(r),r||qe(0))},className:"flex-grow p-4 overflow-y-auto "+("dark"===o?"bg-gray-900":"bg-gray-50"),children:rt?(0,w.jsx)("div",{className:"space-y-2",children:ot.length>0?ot.map(e=>(0,w.jsxs)("div",{onClick:()=>Ft(e),className:"p-3 rounded-lg cursor-pointer "+("dark"===o?"hover:bg-gray-700":"hover:bg-gray-100"),children:[(0,w.jsxs)("div",{className:"flex justify-between text-xs mb-1",children:[(0,w.jsx)("span",{className:"font-bold",children:is(e.sender).name}),(0,w.jsx)("span",{className:""+("dark"===o?"text-gray-400":"text-gray-500"),children:new Date(e.timestamp).toLocaleDateString()})]}),(0,w.jsx)("p",{className:"truncate "+("dark"===o?"text-gray-300":"text-gray-700"),children:e.fileName?`\ud83d\udcce ${e.fileName}`:e.content})]},e.messageId)):(0,w.jsxs)("div",{className:"text-center text-gray-500 mt-10",children:['No results found for "',lt,'"']})}):U?(0,w.jsx)(C,{theme:o}):(0,w.jsxs)("div",{className:"space-y-2",children:[ls.map((e,s)=>{var r;const n=e.sender===(null===t||void 0===t?void 0:t.id),l=new Date(e.timestamp).toDateString(),i=rs!==l;i&&(rs=l);const d=n?null:is(e.sender),c=os(e);return(0,w.jsxs)(a.Fragment,{children:[i&&(0,w.jsx)("div",{className:"text-center my-4",children:(0,w.jsx)("span",{className:"px-3 py-1 rounded-full text-xs font-semibold "+("dark"===o?"bg-gray-700 text-gray-300":"bg-gray-200 text-gray-600"),children:ss(e.timestamp)})}),(0,w.jsxs)("div",{id:`msg-${e.messageId}`,"data-message-index":s,className:`flex items-end gap-2 p-1 rounded-lg transition-all\n                                                            ${n?"justify-end":"justify-start"}\n                                                            ${(null===(r=ot[ct])||void 0===r?void 0:r.messageId)===e.messageId?"bg-yellow-400/30":""}\n                                                        `,children:[!n&&(()=>{const e="group"===ns.type?null===d||void 0===d?void 0:d.profile:ns.profile,t="group"===ns.type?null===d||void 0===d?void 0:d.name:ns.name;return e?(0,w.jsx)("img",{src:e,alt:t,className:"w-8 h-8 rounded-full object-cover self-start flex-shrink-0"}):(0,w.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center self-start flex-shrink-0 "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.x$1,{className:"text-gray-500",size:18})})})(),(0,w.jsxs)("div",{className:"flex flex-col "+(n?"items-end":"items-start"),children:["group"===ns.type&&!n&&(0,w.jsx)("p",{className:"text-xs text-gray-500 mb-1 ml-2 font-semibold "+("dark"===o?"text-gray-400":"text-gray-500"),children:null===d||void 0===d?void 0:d.name}),(0,w.jsx)("div",{onContextMenu:t=>((e,t,s)=>{e.preventDefault(),e.stopPropagation();let a=e.pageX,r=e.pageY;a+180>window.innerWidth&&(a-=180),r+250>window.innerHeight&&(r-=250),Q({visible:!0,x:a,y:r,message:t,index:s})})(t,e,s),className:`rounded-lg max-w-xs md:max-w-md group relative\n                                                                ${"image"===e.type||"deleted"===e.type?"p-0 bg-transparent":""}\n                                                                ${"text"===e.type?n?"bg-blue-600 text-white p-3":"dark"===o?"bg-gray-700 text-white p-3":"bg-gray-200 text-gray-800 p-3":""}\n                                                                ${"audio"===e.type||"file"===e.type?n?"bg-blue-600":"dark"===o?"bg-gray-700":"bg-gray-200":""}\n                                                                `,children:"deleted"===e.type?(0,w.jsxs)("div",{className:"flex items-center gap-2 italic text-sm opacity-70 p-3",children:[(0,w.jsx)("span",{children:"This message was deleted"}),(null===se||void 0===se?void 0:se.index)===s&&(0,w.jsx)("button",{onClick:Gt,className:"font-semibold hover:underline",children:"Undo"})]}):(0,w.jsxs)(w.Fragment,{children:[e.isForwarded&&(0,w.jsxs)("div",{className:"flex items-center gap-1.5 text-xs opacity-70 mb-1 font-semibold",children:[(0,w.jsx)(b.Zzu,{})," Forwarded"]}),e.replyTo&&(0,w.jsxs)("div",{className:"p-2 rounded mb-2 text-sm "+(n?"bg-blue-500":"dark"===o?"bg-gray-600":"bg-gray-300"),children:[(0,w.jsx)("p",{className:"font-semibold",children:e.replyTo.sender===(null===t||void 0===t?void 0:t.id)?"You":is(e.replyTo.sender).name}),(0,w.jsx)("p",{className:"opacity-80 truncate",children:(["image","audio","file"].includes(e.replyTo.type),e.replyTo.content)})]}),"image"===e.type?(0,w.jsxs)("div",{className:"relative",children:[(0,w.jsx)("button",{onClick:()=>Ie(c),children:(0,w.jsx)("img",{src:c,alt:e.fileName||"image",className:"rounded-md max-w-full",style:{maxHeight:"300px"}})}),!n&&(0,w.jsx)("a",{href:c,download:e.fileName,onClick:e=>e.stopPropagation(),className:"absolute bottom-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity",children:(0,w.jsx)(b.WCW,{})})]}):"audio"===e.type?(0,w.jsx)("div",{className:(n?"bg-blue-600":"dark"===o?"bg-gray-700":"bg-gray-200")+" rounded-lg",children:(0,w.jsx)(S,{src:c,fileUrl:c,isSender:n,initialDuration:e.duration,fileSize:e.fileSize,theme:o})}):"file"===e.type?(0,w.jsx)(I,{msg:e,isMyMessage:n,theme:o}):(0,w.jsx)("p",{className:"text-sm break-words",children:e.content})]})}),(0,w.jsxs)("span",{className:"text-xs mt-1 px-1 "+("dark"===o?"text-gray-400":"text-gray-500"),children:["sending"===e.status?"Sending...":"failed"===e.status?"Failed":ts(e.timestamp)," ",e.isEdited?"(edited)":""]})]}),n&&(0,w.jsx)("div",{className:"relative w-8 h-8 self-start flex-shrink-0",children:(0,w.jsx)("img",{src:(null===t||void 0===t?void 0:t.profile)||"https://placehold.co/100x100/E2E8F0/4A5568?text=Me",alt:"current user",className:`w-full h-full rounded-full object-cover ring-2 ${as(e.status)}`})})]})]},e.messageId||e.id)}),Re[R.chatId]&&(0,w.jsxs)("div",{className:"flex items-end gap-2 justify-start",children:[(0,w.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center self-start flex-shrink-0 "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.x$1,{className:"text-gray-500",size:18})}),(0,w.jsx)("div",{className:"flex flex-col items-start",children:(0,w.jsx)("div",{className:"p-3 rounded-lg text-gray-800 "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsxs)("div",{className:"flex items-center justify-center gap-1.5",children:[(0,w.jsx)("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.3s]"}),(0,w.jsx)("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.15s]"}),(0,w.jsx)("span",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce"})]})})})]})]})}),(0,w.jsxs)("div",{className:"flex-shrink-0 flex flex-col p-4 border-t "+("dark"===o?"bg-gray-800 border-gray-700":"bg-white border-gray-200"),children:[ee&&(0,w.jsxs)("div",{className:"p-2 rounded-t-lg flex justify-between items-center "+("dark"===o?"bg-gray-700":"bg-gray-100"),children:[(0,w.jsxs)("div",{className:"text-sm overflow-hidden",children:[(0,w.jsxs)("p",{className:"font-semibold text-blue-600",children:["Replying to ",ee.sender===(null===t||void 0===t?void 0:t.id)?"yourself":is(ee.sender).name]}),(0,w.jsx)("p",{className:"truncate opacity-80 "+("dark"===o?"text-gray-300":"text-gray-600"),children:["image","audio","file"].includes(ee.type)?ee.fileName:ee.content})]}),(0,w.jsx)("button",{onClick:()=>te(null),children:(0,w.jsx)(b.QCr,{})})]}),null!==G.index&&(0,w.jsxs)("div",{className:"p-2 rounded-t-lg flex justify-between items-center "+("dark"===o?"bg-gray-700":"bg-gray-100"),children:[(0,w.jsxs)("div",{className:"text-sm overflow-hidden",children:[(0,w.jsx)("p",{className:"font-semibold text-blue-600",children:"Editing message"}),(0,w.jsx)("p",{className:"truncate opacity-80 "+("dark"===o?"text-gray-300":"text-gray-600"),children:G.originalContent})]}),(0,w.jsx)("button",{onClick:Jt,children:(0,w.jsx)(b.QCr,{})})]}),ns&&(0,w.jsxs)("div",{className:"relative flex items-center w-full space-x-2 "+(ee||null!==G.index?"pt-2":""),children:[V&&(0,w.jsx)("div",{ref:jt,className:"absolute bottom-full mb-2 left-0 z-40 w-[95vw] max-w-sm",children:(0,w.jsx)(j.Ay,{onEmojiClick:e=>z(t=>t+e.emoji),width:"100%",height:350,theme:o})}),(0,w.jsxs)("div",{className:"relative flex-grow",children:[(0,w.jsx)("input",{ref:St,type:"text",placeholder:B?"Recording...":"Type a message...",className:"w-full p-3 pr-24 rounded-full border bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 "+("dark"===o?"bg-gray-700 text-white border-gray-600":"bg-gray-100 border-gray-300"),value:F,onChange:e=>{z(e.target.value),Ht(!0)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),null!==G.index?Xt():Yt())},disabled:B}),(0,w.jsxs)("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[(0,w.jsx)("button",{ref:wt,onClick:()=>q(!V),className:"p-2 rounded-full hover:bg-gray-100 "+("dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-500 hover:text-blue-600"),children:(0,w.jsx)(b.Ky9,{size:20})}),(0,w.jsx)("button",{onClick:()=>ft.current.click(),className:"p-2 rounded-full hover:bg-gray-100 "+("dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-500 hover:text-blue-600"),children:(0,w.jsx)(b.EHs,{size:20})})]})]}),F.trim()||null!==G.index?(0,w.jsx)("button",{onClick:null!==G.index?Xt:Yt,className:"p-3 rounded-full text-white "+(null!==G.index?"bg-green-600 hover:bg-green-700":"bg-blue-600 hover:bg-blue-700"),children:null!==G.index?(0,w.jsx)(b.CMH,{size:20}):(0,w.jsx)(b.Cer,{size:20})}):(0,w.jsx)("button",{onClick:()=>{B?_t():Zt()},className:"p-3 rounded-full hover:bg-gray-100 "+(B?"text-red-500 animate-pulse":"dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-500 hover:text-blue-600"),children:B?(0,w.jsx)(b.wFo,{size:20}):(0,w.jsx)(b.i0t,{size:20})}),(0,w.jsx)("input",{type:"file",ref:ft,onChange:async e=>{const s=e.target.files[0];if(!s||!R)return;let a="file";s.type.startsWith("image/")?a="image":s.type.startsWith("audio/")&&(a="audio");const r=Date.now().toString()+Math.random().toString(36).substring(2,9),n=URL.createObjectURL(s),l={id:r,messageId:r,sender:t.id,content:n,timestamp:(new Date).toISOString(),status:"sending",type:a,fileName:s.name,fileSize:s.size,fileUrl:n,isEdited:!1};Wt(R.chatId,l),W(e=>({...e,[R.chatId]:[...e[R.chatId]||[],l]}));const i=new FormData;i.append("file",s),i.append("sender",t.id),i.append("client_id",r),i.append("fileType",s.type),i.append("type","group"===R.type?"TEAM":"PRIVATE"),"group"===R.type?i.append("groupId",R.chatId):i.append("receiver",R.chatId);try{await(async e=>{try{const t=await c.post("/chat/upload",e,{headers:{"Content-Type":"multipart/form-data"}});return console.log("Response:",t),t.data}catch(t){throw console.error("File upload failed:",t),t}})(i)}catch(o){console.error("File upload failed in component:",o),W(e=>{const t=(e[R.chatId]||[]).map(e=>e.id===r?{...e,status:"failed"}:e);return{...e,[R.chatId]:t}})}finally{e.target.value=null}},className:"hidden"})]})]})]}):(0,w.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,w.jsxs)("div",{className:"text-center",children:[(0,w.jsx)(b.YXz,{className:"mx-auto text-6xl "+("dark"===o?"text-gray-600":"text-gray-300")}),(0,w.jsx)("p",{className:"mt-4 text-xl text-center "+("dark"===o?"text-gray-400":"text-gray-600"),children:"Select a chat to begin"}),(0,w.jsx)("p",{className:"text-sm "+("dark"===o?"text-gray-500":"text-gray-400"),children:"Start a conversation with your team or colleagues."})]})})}),Oe&&(0,w.jsxs)("button",{onClick:()=>zt(),className:"absolute bottom-24 right-8 z-10 bg-blue-600/80 backdrop-blur-sm text-white rounded-full p-3 shadow-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:scale-110 animate-fade-in","aria-label":"Scroll to bottom",children:[Ve>0&&(0,w.jsx)("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center",children:Ve>9?"9+":Ve}),(0,w.jsx)(b.Vr3,{size:20})]})]}),Be&&(0,w.jsx)($,{chat:Be,onClose:()=>He(null),theme:o}),J.visible&&(0,w.jsx)("div",{ref:It,style:{top:J.y,left:J.x},className:"absolute rounded-md shadow-lg z-50 text-sm "+("dark"===o?"bg-gray-800":"bg-white"),children:(0,w.jsx)("ul",{className:"py-1",children:"deleted"===J.message.type?(0,w.jsxs)("li",{onClick:()=>Qt(!1),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600 "+("dark"===o?"text-red-400 hover:bg-gray-700":""),children:[(0,w.jsx)(b.qbC,{})," Delete for me"]}):(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)("li",{onClick:()=>{te(J.message),Q({visible:!1,x:0,y:0,message:null,index:null}),St.current.focus()},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 "+("dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-700"),children:[(0,w.jsx)(b.w1Z,{})," Reply"]}),(0,w.jsxs)("li",{onClick:async()=>{var e;if(null!==(e=J.message)&&void 0!==e&&e.messageId)try{const e=J.message.messageId,s=await(async(e,t)=>{try{const s=await c.post(`/chat/pin/${e}?userId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to pin message ${e}:`,s),s}})(e,t.id);ne(s)}catch(s){console.error("Failed to pin message:",s)}finally{Q({visible:!1,x:0,y:0,message:null,index:null})}},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 "+("dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-700"),children:[(0,w.jsx)(b.LBY,{})," Pin"]}),(0,w.jsxs)("li",{onClick:()=>{ie({visible:!0,message:J.message}),Q({visible:!1,x:0,y:0,message:null,index:null})},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 "+("dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-700"),children:[(0,w.jsx)(b.Zzu,{})," Forward"]}),"sending"!==J.message.status&&"failed"!==J.message.status&&(0,w.jsxs)(w.Fragment,{children:[J.message.sender===(null===t||void 0===t?void 0:t.id)&&"text"===J.message.type&&!J.message.isForwarded&&new Date-new Date(J.message.timestamp)<9e5&&(0,w.jsxs)("li",{onClick:()=>{K({index:J.index,originalContent:J.message.content}),z(J.message.content),Q({visible:!1,x:0,y:0,message:null,index:null}),St.current.focus()},className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 "+("dark"===o?"text-gray-300 hover:bg-gray-700":"text-gray-700"),children:[(0,w.jsx)(b.uO9,{})," Edit"]}),(0,w.jsx)("hr",{className:"my-1 "+("dark"===o?"border-gray-700":"")}),(0,w.jsxs)("li",{onClick:()=>Qt(!1),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600 "+("dark"===o?"text-red-400 hover:bg-gray-700":""),children:[(0,w.jsx)(b.qbC,{})," Delete for me"]}),J.message.sender===(null===t||void 0===t?void 0:t.id)&&(0,w.jsxs)("li",{onClick:()=>Qt(!0),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3 text-red-600 "+("dark"===o?"text-red-400 hover:bg-gray-700":""),children:[(0,w.jsx)(b.qbC,{})," Delete for everyone"]})]})]})})}),le.visible&&(0,w.jsx)("div",{className:"fixed inset-0 bg-opacity-100 flex items-center justify-center z-[100]",children:(0,w.jsxs)("div",{className:"rounded-lg shadow-2xl w-full max-w-md "+("dark"===o?"bg-gray-800 text-white":"bg-white"),children:[(0,w.jsxs)("div",{className:"p-4 border-b flex justify-between items-center "+("dark"===o?"border-gray-700":"border-gray-200"),children:[(0,w.jsx)("h3",{className:"font-bold text-lg",children:"Forward message to..."}),(0,w.jsx)("button",{onClick:()=>ie({visible:!1,message:null}),children:(0,w.jsx)(b.QCr,{})})]}),(0,w.jsx)("div",{className:"p-4",children:(0,w.jsx)("input",{type:"text",placeholder:"Search for users or groups",className:"w-full p-2 border rounded-lg "+("dark"===o?"bg-gray-700 text-white border-gray-600":"bg-gray-100 border-gray-300"),value:ce,onChange:e=>ue(e.target.value)})}),(0,w.jsx)("div",{className:"h-64 overflow-y-auto p-4",children:At.filter(e=>{var t;return null===(t=e.name)||void 0===t?void 0:t.toLowerCase().includes(ce.toLowerCase())}).map(e=>(0,w.jsxs)("div",{className:"flex items-center p-2 rounded-lg hover:bg-gray-100 "+("dark"===o?"hover:bg-gray-700":""),children:[(0,w.jsx)("input",{type:"checkbox",id:`fwd-${e.chatId}`,className:"mr-3 h-4 w-4 accent-blue-600",checked:oe.includes(e.chatId),onChange:t=>{t.target.checked?de([...oe,e.chatId]):de(oe.filter(t=>t!==e.chatId))}}),(0,w.jsxs)("label",{htmlFor:`fwd-${e.chatId}`,className:"flex-grow flex items-center gap-3 cursor-pointer",children:["group"===e.type?(0,w.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.YXz,{className:"text-gray-500"})}):(0,w.jsx)("img",{src:e.profile,alt:e.name,className:"w-10 h-10 rounded-full object-cover",onError:e=>{e.target.src="https://placehold.co/100x100/E2E8F0/4A5568?text=U"}}),(0,w.jsx)("span",{className:""+("dark"===o?"text-gray-300":"text-gray-800"),children:e.name})]})]},e.chatId))}),(0,w.jsx)("div",{className:"p-4 border-t text-right "+("dark"===o?"border-gray-700":"border-gray-200"),children:(0,w.jsx)("button",{onClick:async()=>{const e=le.message;if(!e||0===oe.length)return;const s={sender:t.id,forwardMessageId:e.messageId,forwardTo:oe.map(e=>{const t=At.find(t=>t.chatId===e);return"private"===t.type?{receiver:t.chatId}:{groupId:t.chatId}})};try{await(async e=>{try{const t=await c.post("/chat/forward",e);return console.log("Response:",t),t.data}catch(t){throw console.error(`Failed to forward message ${e.forwardMessageId}:`,t),t}})(s);const e={...le.message,sender:t.id,timestamp:(new Date).toISOString()};oe.forEach(t=>{Wt(t,e)})}catch(a){console.error("Failed to forward message:",a)}finally{ie({visible:!1,message:null}),de([]),ue("")}},disabled:0===oe.length,className:"bg-blue-600 text-white px-4 py-2 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer",children:"Forward"})})]})}),he&&ns&&"group"!==ns.type&&(0,w.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]",onClick:()=>xe(!1),children:(0,w.jsx)("img",{src:ns.profile,alt:ns.name,className:"max-w-[80vw] max-h-[90vh] object-contain",onClick:e=>e.stopPropagation()})}),pe&&"group"===(null===ns||void 0===ns?void 0:ns.type)&&(0,w.jsx)("div",{className:"fixed inset-0 bg-opacity-100 flex items-center justify-center z-[100]",onClick:()=>fe(!1),children:(0,w.jsxs)("div",{className:"rounded-lg shadow-2xl w-full max-w-lg h-[80vh] flex flex-col "+("dark"===o?"bg-gray-800 text-white":"bg-white"),onClick:e=>e.stopPropagation(),children:[(0,w.jsxs)("div",{className:"p-4 border-b flex justify-between items-center flex-shrink-0 "+("dark"===o?"border-gray-700":"border-gray-200"),children:[(0,w.jsx)("h3",{className:"font-bold text-xl",children:"Group Info"}),(0,w.jsx)("button",{onClick:()=>fe(!1),className:"p-2 rounded-full "+("dark"===o?"hover:bg-gray-700 text-gray-300":"hover:bg-gray-200"),children:(0,w.jsx)(b.QCr,{})})]}),(0,w.jsx)("div",{className:"flex border-b flex-shrink-0 "+("dark"===o?"border-gray-700":"border-gray-200"),children:["Overview","Members","Media","Files","Links"].map(e=>(0,w.jsx)("button",{onClick:()=>be(e),className:"flex-1 p-3 text-sm font-semibold "+(ye===e?"text-blue-600 border-b-2 border-blue-600":"dark"===o?"text-gray-400 hover:bg-gray-700":"text-gray-500 hover:bg-gray-100"),children:e},e))}),(0,w.jsxs)("div",{className:"p-4 overflow-y-auto flex-grow",children:["Overview"===ye&&(0,w.jsxs)("div",{className:"flex flex-col items-center text-center space-y-4",children:[(0,w.jsx)("div",{className:"w-40 h-40 rounded-full flex items-center justify-center "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.YXz,{className:"text-gray-500",size:80})}),(0,w.jsx)("h2",{className:"text-2xl font-bold",children:ns.name}),(0,w.jsxs)("p",{className:"text-gray-600 "+("dark"===o?"text-gray-400":""),children:[ns.memberCount||0," members"]})]}),"Members"===ye&&(0,w.jsx)("div",{className:"space-y-3",children:we?(0,w.jsx)("p",{className:"text-center text-gray-500",children:"Loading members..."}):ve.map((e,t)=>(0,w.jsxs)("div",{className:"flex items-center gap-4 p-2 rounded-lg "+("dark"===o?"hover:bg-gray-700":"hover:bg-gray-50"),children:[e.employeeImage?(0,w.jsx)("img",{src:e.employeeImage,alt:e.displayName,className:"w-10 h-10 rounded-full object-cover"}):(0,w.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center "+("dark"===o?"bg-gray-700":"bg-gray-200"),children:(0,w.jsx)(b.x$1,{className:"text-gray-500",size:20})}),(0,w.jsxs)("div",{children:[(0,w.jsx)("span",{className:"font-semibold "+("dark"===o?"text-white":"text-gray-800"),children:e.displayName}),e.jobTitlePrimary&&(0,w.jsx)("p",{className:"text-sm "+("dark"===o?"text-gray-400":"text-gray-500"),children:e.jobTitlePrimary})]})]},e.employeeId||t))}),"Media"===ye&&(st?(0,w.jsx)("p",{className:"text-center p-4 text-gray-500",children:"Loading Media..."}):(0,w.jsx)("div",{className:"grid grid-cols-3 md:grid-cols-4 gap-2",children:Je.length>0?Je.map((e,t)=>(0,w.jsx)("button",{onClick:()=>Ie(os(e)),children:(0,w.jsx)("img",{src:os(e),alt:e.fileName,className:"w-full h-24 object-cover rounded-md cursor-pointer hover:opacity-80"})},t)):(0,w.jsx)("p",{className:"col-span-full text-center p-4 text-gray-500",children:"No media found."})})),"Files"===ye&&(st?(0,w.jsx)("p",{className:"text-center p-4 text-gray-500",children:"Loading Files..."}):(0,w.jsx)("div",{className:"space-y-3",children:Ge.length>0?Ge.map(e=>(0,w.jsx)(I,{msg:e,isMyMessage:!1,theme:o},e.id)):(0,w.jsx)("p",{className:"text-center p-4 text-gray-500",children:"No files found in this chat."})})),"Links"===ye&&(st?(0,w.jsx)("p",{className:"text-center p-4 text-gray-500",children:"Loading Links..."}):(0,w.jsx)("div",{className:"space-y-3",children:(()=>{const e=et.flatMap(e=>{const t=e.content.match(/(https?:\/\/[^\s]+)/g);return t?t.map(t=>({id:e.id,url:t,sender:is(e.sender).name,timestamp:e.timestamp})):[]});return e.length>0?e.map((e,t)=>(0,w.jsxs)("div",{className:"p-3 rounded-lg "+("dark"===o?"bg-gray-700":"bg-gray-100"),children:[(0,w.jsx)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline break-all",children:e.url}),(0,w.jsxs)("p",{className:"text-xs mt-1 "+("dark"===o?"text-gray-400":"text-gray-500"),children:["Shared by ",e.sender," on ",new Date(e.timestamp).toLocaleDateString()]})]},`${e.id}-${t}`)):(0,w.jsx)("p",{className:"text-center p-4 "+("dark"===o?"text-gray-400":"text-gray-500"),children:"No links found in this chat."})})()}))]})]})}),ke&&(0,w.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[120]",onClick:()=>Ie(null),children:(0,w.jsx)("img",{src:ke,alt:"Full view",className:"max-w-[90vw] max-h-[90vh] object-contain",onClick:e=>e.stopPropagation()})}),Me&&(0,w.jsx)("div",{className:"fixed inset-0 bg-opacity-100 flex items-center justify-center z-[110]",children:(0,w.jsxs)("div",{className:"rounded-lg shadow-xl p-6 w-full max-w-sm "+("dark"===o?"bg-gray-800":"bg-white"),children:[(0,w.jsx)("h3",{className:"text-lg font-bold mb-4 "+("dark"===o?"text-white":"text-gray-800"),children:"Clear Chat?"}),(0,w.jsx)("p",{className:"mb-6 "+("dark"===o?"text-gray-400":"text-gray-600"),children:"Are you sure you want to clear all messages in this chat? This action cannot be undone."}),(0,w.jsxs)("div",{className:"flex justify-end gap-4",children:[(0,w.jsx)("button",{onClick:()=>Ee(!1),className:"px-4 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 "+("dark"===o?"bg-gray-600 text-white hover:bg-gray-700":""),children:"Cancel"}),(0,w.jsx)("button",{onClick:async()=>{if(R)try{await(async(e,t)=>{try{const s=await c.post(`/chat/clear?userId=${e}&chatId=${t}`);return console.log("Response:",s),s.data}catch(s){throw console.error(`Failed to clear chat for ${t}:`,s),s}})(t.id,R.chatId),W(e=>({...e,[R.chatId]:[]})),Wt(R.chatId,null)}catch(e){console.error("Failed to clear chat:",e)}finally{Ee(!1)}},className:"px-4 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700",children:"Clear Chat"})]})]})})]})},M=()=>(0,w.jsxs)("div",{className:"flex items-center space-x-4 p-3",children:[(0,w.jsx)("div",{className:"w-11 h-11 bg-gray-200 rounded-full animate-pulse"}),(0,w.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,w.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4 animate-pulse"}),(0,w.jsx)("div",{className:"h-3 bg-gray-200 rounded w-1/2 animate-pulse"})]})]}),E=e=>{let{theme:t}=e;return(0,w.jsxs)("div",{className:"flex w-full h-full p-0 md:p-4 md:gap-4 "+("dark"===t?"bg-gray-900":"bg-gray-100"),children:[(0,w.jsxs)("div",{className:"w-full md:w-[30%] h-full p-4 flex flex-col shadow-xl md:rounded-lg space-y-4 "+("dark"===t?"bg-gray-800":"bg-white"),children:[(0,w.jsx)("div",{className:"h-12 bg-gray-200 rounded-lg animate-pulse mb-4"}),(0,w.jsxs)("div",{className:"flex-grow space-y-2 pr-2 overflow-hidden",children:[(0,w.jsx)(M,{}),(0,w.jsx)(M,{}),(0,w.jsx)(M,{}),(0,w.jsx)(M,{}),(0,w.jsx)(M,{}),(0,w.jsx)(M,{}),(0,w.jsx)(M,{})]})]}),(0,w.jsx)("div",{className:"hidden md:flex flex-col w-[70%] h-full md:rounded-lg shadow-xl "+("dark"===t?"bg-gray-800":"bg-white"),children:(0,w.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,w.jsx)("div",{className:"text-center",children:(0,w.jsx)("p",{className:"text-xl text-gray-400",children:"Loading Chats..."})})})})]})};const R=function(){const{userId:e}=(0,r.g)(),{theme:t}=(0,a.useContext)(f.o),[s,n]=(0,a.useState)({groups:[],privateChatsWith:[]}),[l,i]=(0,a.useState)(!0),[o,d]=(0,a.useState)(!1),[u,g]=(0,a.useState)(0),[m,h]=(0,a.useState)(!0),p=(0,a.useRef)(!1),y={name:"You",id:e,profile:"https://placehold.co/100x100/E2E8F0/4A5568?text=Me"},b=async t=>{if(console.log(`%c loadChats function started for page: ${t}`,"color: blue; font-weight: bold;"),m&&!p.current){p.current=!0,0===t?i(!0):d(!0);try{console.log(`%c Sending API request for page: ${t}`,"color: green;");const s=await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{const a=await c.get(`/chat/overview/${e}?page=${t}&size=${s}`);return console.log(`Response for page ${t}:`,a),a.data}catch(a){return console.error("Failed to fetch chat overview:",a),[]}}(e,t,10);if(0===s.length)return void h(!1);const a=x(s,e);n(e=>{if(0===t)return a;const s=new Set(e.groups.map(e=>e.chatId)),r=new Set(e.privateChatsWith.map(e=>e.chatId)),n=a.groups.filter(e=>!s.has(e.chatId)),l=a.privateChatsWith.filter(e=>!r.has(e.chatId));return{groups:[...e.groups,...n],privateChatsWith:[...e.privateChatsWith,...l]}}),s.length<10&&h(!1)}catch(s){console.error("Error loading chats:",s)}finally{0===t&&i(!1),d(!1),p.current=!1,console.log(`%c Finished fetch for page ${t}. Lock released.`,"color: orange;")}}else console.log(`%c Request for page ${t} blocked. hasMore=${m}, fetchingMore.current=${p.current}`,"color: red;")};return(0,a.useEffect)(()=>{e&&b(0)},[e]),(0,w.jsx)("div",{className:"flex h-full w-full "+("dark"===t?"bg-gray-900":"bg-gray-100"),children:l?(0,w.jsx)(E,{theme:t}):(0,w.jsx)(T,{currentUser:y,chats:s,loadMoreChats:()=>{if(console.log("handleLoadMore triggered!"),p.current||!m)return void console.log("handleLoadMore blocked by ref lock or no more data.");const e=u+1;g(e),b(e)},hasMore:m,isFetchingMore:o,theme:t})})}}}]);
//# sourceMappingURL=654.f3d75c31.chunk.js.map